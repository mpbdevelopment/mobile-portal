<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" name="theme-color" content="#0e2f7b" />
  <title>Subscription / Extension</title>
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  />

  <!-- Viewport fit for iPhone safe-area -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <style>
    /* 1) BODY & GLOBAL */
    body {
      margin: 0;
      padding-bottom: calc(80px + env(safe-area-inset-bottom));
      background-color: #f9f9f9;
    }
    .btn-primary {
      background-color: #0e2f7b !important;
      border-color: #0e2f7b !important;
    }
    .btn-primary:hover,
    .btn-primary:focus,
    .btn-primary:active {
      background-color: #0c2563 !important;
      border-color: #0c2563 !important;
    }

    /* 2) HEADER */
    header {
      background-color: #0e2f7b;
      color: #fff;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header img {
      height: 40px;
    }

    /* 3) FIXED BOTTOM NAV (same style as main) */
    .nav-bottom {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding-bottom: env(safe-area-inset-bottom);
      background-color: #fff;
      border-top: 1px solid #ddd;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .nav-bottom .nav-link {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      color: #000;
    }
    .nav-bottom .nav-link.active {
      background-color: #0e2f7b; 
      color: #fff;
      font-weight: 500;
    }
    /* Optional narrower icons for profile or forum */
    .nav-bottom .nav-profile {
      flex: 0 0 auto;
      width: 50px;
      text-align: center;
      padding: 6px 0;
      font-size: 1.1rem;
    }
    .nav-bottom .nav-forum {
      flex: 0 0 auto;
      width: 50px;
      text-align: center;
      padding: 6px 0;
      font-size: 1.2rem;
    }

    /* 4) CARDS & LAYOUT */
    .card {
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #fff;
    }

    .arrow {
  display: inline-block;
  transition: transform 0.2s ease;
}

a[data-bs-toggle="collapse"][aria-expanded="true"] .arrow {
  transform: rotate(180deg);
}

a[data-bs-toggle="collapse"][aria-expanded="false"] .arrow {
  transform: rotate(0deg);
}

  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <h5 class="mb-0">Montclair Pickleball Memberships</h5>
    <img src="icons/banner-logo.png" alt="Montclair Pickleball Logo" />
  </header>

  <!-- MAIN CONTAINER -->
  <div class="container py-4">
    <div class="bg-white p-3 rounded shadow-sm mb-3 col-md-8 d-block mx-auto">
      <h3 class="text-center">Manage Your Membership</h3>
    </div>

    <!-- Subscription Status -->
    <div class="row justify-content-center mb-3">
      <div class="col-md-8">
        <div class="alert alert-info" id="subStatus" style="display: none;"></div>
      </div>
    </div>

    <img 
    src="icons/memberGraphic.png" 
    alt="Membership" 
    class="img-fluid mb-3 col-md-8 d-block mx-auto rounded"
  >

  <div class="list-group bg-white p-3 rounded shadow-sm mb-3 col-md-8 d-block mx-auto">
    <!-- Membership Details now on top -->
    <a class="list-group-item list-group-item-action" data-bs-toggle="collapse" href="#moreOptions" role="button" aria-expanded="false" aria-controls="moreOptions">
      Membership Details <span class="arrow">&#9660;</span>
    </a>
    <div class="collapse" id="moreOptions">
      <div class="list-group">
        <div class="list-group-item list-group-item-action bg-white border rounded mb-1 mt-1 shadow-sm py-2">
          <strong>SILVER MEMBERSHIP</strong><br>
          MONTHLY BENEFITS
          <ul class="mb-0 mt-1 ps-3">
            <li>Unlimited Free Open Play</li>
            <li>Unlimited Free Open Drilling</li>
            <li>20% off ALL Programs + Events</li>
            <li>20% off Court Rentals</li>
            <li>Access to Member-Only Events</li>
            <li>Access to Early Signups</li>
            <li>Valid at all Montclair Pickleball Locations</li>
          </ul>
        </div>
        
        <!-- GOLD MEMBERSHIP -->
        <div class="list-group-item list-group-item-action bg-white border rounded mb-1 mt-1 shadow-sm py-2">
          <strong>GOLD MEMBERSHIP</strong><br>
          MONTHLY BENEFITS
          <ul class="mb-0 mt-1 ps-3">
            <li>4 Free Programs (1 Free Program/Week | Includes Clinics, Guided Drilling, & Guided Open Play)</li>
            <li>Unlimited Free Open Play</li>
            <li>Unlimited Free Open Drilling</li>
            <li>20% off ALL Programs + Events</li>
            <li>20% off Court Rentals</li>
            <li>Access to Member-Only Events</li>
            <li>Access to Early Signups</li>
            <li>Valid at all Montclair Pickleball Locations</li>
          </ul>
        </div>
        
        <!-- TRIPLE CROWN MEMBERSHIP -->
        <div class="list-group-item list-group-item-action bg-white border rounded mb-1 mt-1 shadow-sm py-2">
          <strong>TRIPLE CROWN MEMBERSHIP</strong><br>
          MONTHLY BENEFITS
          <ul class="mb-0 mt-1 ps-3">
            <li>Unlimited Free Programs</li>
            <li>Unlimited Free Open Play</li>
            <li>Unlimited Free Open Drilling</li>
            <li>Unlimited Free Events</li>
            <li>Unlimited Free Court Rentals</li>
            <li>Access to Member-Only Events</li>
            <li>Access to Early Signups</li>
            <li>Valid at all Montclair Pickleball Locations</li>
          </ul>
        </div>
      </div>            
    </div>
  
    <!-- Membership FAQs now below Membership Details -->
    <a href="https://www.montclairpickleballbc.com/memberships#faq" target="_blank" rel="noopener noreferrer" class="list-group-item list-group-item-action">
      Membership FAQs
    </a>
  </div>  

    <!-- MAIN CARD FOR PLAN SELECTION / EXTENSION -->
    <div class="row justify-content-center">
      <div class="col-md-8">

        <!-- 1) Plan Selection -->
        <div class="bg-white p-3 rounded shadow-sm mb-3" id="planSelectionCard">
          <h5>Select a Membership Plan</h5>
          <div class="form-check mb-1">
            <input
              class="form-check-input"
              type="radio"
              name="plan"
              id="planSilver"
              value="99"
              checked
            />
            <label class="form-check-label" for="planSilver">
              Silver - $99 / 30 days
            </label>
          </div>
          <div class="form-check mb-1">
            <input
              class="form-check-input"
              type="radio"
              name="plan"
              id="planGold"
              value="175"
            />
            <label class="form-check-label" for="planGold">
              Gold - $175 / 30 days
            </label>
          </div>
          <div class="form-check mb-1">
            <input
              class="form-check-input"
              type="radio"
              name="plan"
              id="planTriple"
              value="499"
            />
            <label class="form-check-label" for="planTriple">
              Triple Crown - $499 / 30 days
            </label>
          </div>
        </div>

        <!-- 2) Months + Duration + End Date + Cost -->
        <div class="bg-white p-3 rounded shadow-sm mb-3">
          <h5 id="purchaseExtend">Number of Months to Purchase/Extend</h5>
          <div class="input-group mb-2">
            <label class="input-group-text" for="monthsInput">Months</label>
            <input
              type="number"
              class="form-control"
              id="monthsInput"
              value="1"
              min="1"
              max="8"
              step="1"
            />
          </div>

          <!-- Start Date Picker -->
          <div class="bg-light p-2 mb-2 rounded" id="startGroup">
            <h6>Select Start Date</h6>
            <div class="input-group">
              <label class="input-group-text" for="startDateInput">Start</label>
              <input
                type="date"
                class="form-control"
                id="startDateInput"
              />
            </div>
          </div>

          <p class="mb-1">
            <strong>Extended Membership Duration:</strong> <span id="durationDays">30</span> days
          </p>
          <p class="mb-1">
            <strong>Renews On (Valid Through):</strong>
            <span id="endDateDisplay">[calculated]</span>
          </p>
          <p class="mb-1">
            <strong>Total Billed Now:</strong> $<span id="totalCost">99</span>
          </p>
          <p id="contactToUpgrade" class="mb-0" style="display:none">
            <i>Please contact us at contact@montclairpickleball.com if you would like to upgrade or start your membership early.</i>
          </p>
          <p><i>Your membership benefits are accessible through the portal, and are automatically applied on the "Register" tab.</i></p>
        </div>

        <!-- Purchase Buttons -->
        <div class="bg-white p-3 rounded shadow-sm mb-3">
          <button id="purchaseBtn" class="btn btn-primary w-100 mb-2" disabled style="display: none">
            Confirm Purchase
          </button>
          <button
            id="addCardBtn"
            class="btn btn-outline-secondary w-100"
            style="display: none;"
          >
            <i class="bi bi-credit-card"></i> Add Card & Purchase
          </button>
          <div
            class="alert alert-info mt-2 mb-0"
            id="statusMessage"
          >
            Loading...
          </div>
          <button id="cancelBtn" class="btn btn-danger w-100 mt-2" style="display: none;">
            Cancel Membership
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Cancel Membership</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>
If you choose to cancel your membership, your benefits will remain active until the end of your paid cycle. You will not be billed again, however, you may renew your membership at any time. We cannot prorate your membership for the remainder of your paid cycle.
          </p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            No, Keep Membership
          </button>
          <button
            type="button"
            class="btn btn-danger"
            id="confirmCancelBtn"
          >
            Yes, Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PAYMENT MODAL -->
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Payment Profile</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>Please add a payment method to continue.</p>
          <form id="payment-form">
            <div class="mb-3">
              <label for="name-input" class="form-label">Name</label>
              <input
                type="text"
                class="form-control"
                id="name-input"
                required
              />
            </div>
            <div class="mb-3">
              <label for="card-element" class="form-label">Card</label>
              <div
                id="card-element"
                class="form-control"
                style="height:auto;"
              ></div>
              <div
                id="card-errors"
                class="card-errors text-danger mt-1"
              ></div>
            </div>
            <button id='submitBtn' type="submit" class="btn btn-primary w-100">
              Add Card on File &amp; Purchase
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div
    class="modal fade"
    id="successModal"
    tabindex="-1"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <!-- No close button -->
          <h5 class="modal-title">Purchase Successful!</h5>
        </div>
        <div class="modal-body">
          <p>Your membership has been successfully updated!<br>Please note that if you added a new card on file it may take a few minutes to update in the portal.</p>
        </div>
        <div class="modal-footer">
          <!-- Single OK button that redirects -->
          <button
            type="button"
            class="btn btn-primary"
            id="successOkBtn"
          >
            OK
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- FIXED BOTTOM NAV -->
  <nav class="nav nav-bottom d-flex justify-content-around">
    <a class="nav-link" onclick="goBack()" role="button">
      <span class="d-block">Back to Home</span>
    </a>
  </nav>

  <!-- Bootstrap + Stripe + Firebase (compat) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    /* ================================================
       1) 'Go Back' helper for bottom nav
       ================================================ */
       function goBack() {
        // Check if there's history to go back to
        if (window.history.length > 1) {
            window.history.back();
        } else {
            // Fallback to main portal if no history
            window.location.href = "index.html";
        }
        return false; // Prevent default link behavior
    }

    /* ================================================
       2) Firebase init (compat build)
       ================================================ */
    const firebaseConfig = {
      apiKey: "AIzaSyDP2YjuFB8SiSJTsMH7yqGdyrMpiK05AEo",
      authDomain: "mp-subscriptions.firebaseapp.com",
      projectId: "mp-subscriptions",
      storageBucket: "mp-subscriptions.firebasestorage.app",
      messagingSenderId: "228607825379",
      appId: "1:228607825379:web:02cddb56b0465cca603cd6",
      measurementId: "G-8NXV5DBFZB"
    };
    firebase.initializeApp(firebaseConfig);

    /* ================================================
       3) Stripe initialization
       ================================================ */
    const stripe = Stripe("pk_live_51N9BzSHaWNal9rme3vwhLRs3vRgdqPQO35KZ2WQHPvefzbh2dP1VRCLTc8wKBNxN3jk8VXkeu8P3MJxnoJ1A3JaP00OotZGNnb");
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
      style: { base: { fontSize: '16px' } }
    });
    cardElement.mount('#card-element');

    /* ================================================
       4) DOM references
       ================================================ */
    const statusMessage    = document.getElementById("statusMessage");
    const subStatus        = document.getElementById("subStatus");
    const planSelectionCard= document.getElementById("planSelectionCard");
    const purchaseBtn      = document.getElementById("purchaseBtn");
    const addCardBtn       = document.getElementById("addCardBtn");
    const paymentModal     = new bootstrap.Modal(document.getElementById("paymentModal"));
    const paymentForm      = document.getElementById("payment-form");
    const nameInput        = document.getElementById("name-input");
    const cardErrors       = document.getElementById("card-errors");
    const monthsInput      = document.getElementById("monthsInput");
    const startInput       = document.getElementById("startDateInput");
    const durationDaysEl   = document.getElementById("durationDays");
    const endDateDisplay   = document.getElementById("endDateDisplay");
    const totalCostEl      = document.getElementById("totalCost");
    const purchaseExtend = document.getElementById("purchaseExtend");
    const cancelBtn = document.getElementById("cancelBtn");
    const cancelModalEl = document.getElementById("cancelModal");
    const cancelModal = new bootstrap.Modal(cancelModalEl);
    const confirmCancelBtn = document.getElementById("confirmCancelBtn");

    /* Hard cap: memberships may not extend beyond this date */
    const MAX_END_DATE = new Date("2025-11-16T23:59:59");


    /* Grab from localStorage */
    const playerEmail = localStorage.getItem("playerEmail");
    const storedName  = localStorage.getItem("playerFullName");
    if (storedName) nameInput.value = storedName;

    /* Netlify function endpoints */
    const findStripeUrl                = "https://merry-rugelach-c028d1.netlify.app/.netlify/functions/findStripe";
    const createStripeUrl              = "https://merry-rugelach-c028d1.netlify.app/.netlify/functions/createStripe";
    const attachStripeUrl              = "https://merry-rugelach-c028d1.netlify.app/.netlify/functions/attachStripe";
    const chargeOneTimeWithCustomerUrl = "https://merry-rugelach-c028d1.netlify.app/.netlify/functions/chargeOneTimeWithCustomer";

    let existingCustomerId     = null; // Stripe customer
    let defaultPaymentMethodId = null; // Stripe PM
    let currentSubscription    = null; // Our Firebase subscription record

    /* ================================================
       5) On page load: find existing Stripe & sub data
       ================================================ */
    document.addEventListener("DOMContentLoaded", async () => {
      if (!playerEmail) {
        statusMessage.textContent = "No playerEmail found in localStorage!";
        purchaseBtn.disabled = true;
        return;
      }

      // Setup date picker defaults
      const today = new Date();
      const april7_2025 = new Date("2025-04-07T00:00:00");

      const yyyy = today.getFullYear();
      const mm   = String(today.getMonth() + 1).padStart(2, "0");
      const dd   = String(today.getDate()).padStart(2, "0");
      const todayStr = `${yyyy}-${mm}-${dd}`;
      startInput.min = todayStr;
      // Also enforce a maximum start date so that a minimum 30-day purchase cannot exceed MAX_END_DATE
      const oneMonthMs = 30 * 86400000;
      const latestStartForOneMonth = new Date(MAX_END_DATE.getTime() - oneMonthMs);
      const maxY = latestStartForOneMonth.getFullYear();
      const maxM = String(latestStartForOneMonth.getMonth() + 1).padStart(2, "0");
      const maxD = String(latestStartForOneMonth.getDate()).padStart(2, "0");
      startInput.max = `${maxY}-${maxM}-${maxD}`;

      if (today < april7_2025) {
        startInput.value = "2025-04-07";
      } else {
        startInput.value = todayStr;
      }

      statusMessage.textContent = "Checking Stripe status...";

      try {
        // 1) findStripe
        const stripeResp = await fetch(`${findStripeUrl}?email=${encodeURIComponent(playerEmail)}`);
        const stripeData = await stripeResp.json();

        if (!stripeData.success) {
          statusMessage.textContent = "Error from findStripe: " + JSON.stringify(stripeData.error);
          purchaseBtn.disabled = true;
          return;
        }
        if (!stripeData.exists) {
          existingCustomerId = null;
          defaultPaymentMethodId = null;
          statusMessage.textContent = "You don't have a card on file. Please add a card to purchase a membership.";
          purchaseBtn.disabled = true;
          addCardBtn.style.display = "block";
        } else {
          existingCustomerId = stripeData.customer.id;
          defaultPaymentMethodId = stripeData.customer.invoice_settings?.default_payment_method || null;

          if (stripeData.cardLast4) {
            statusMessage.textContent = `Card on file: **** **** **** ${stripeData.cardLast4}`;
            purchaseBtn.style.display = 'block';
            purchaseBtn.disabled = false;
            addCardBtn.style.display = "none";
          } else {
            statusMessage.textContent = "You don't have a card on file. Please add a card to purchase a membership.";
            purchaseBtn.disabled = true;
            addCardBtn.style.display = "block";
          }

          // 2) Check Firebase subscription
          const subRef = firebase.database().ref("subscriptions/" + existingCustomerId);
          const snapshot = await subRef.once("value");
          if (snapshot.exists()) {
            currentSubscription = snapshot.val();
            updateUIWithSubscription(currentSubscription);
            purchaseExtend.textContent = "Extend Your Membership";
            document.getElementById('contactToUpgrade').style.display='block';
          } else {
            currentSubscription = null;
            purchaseExtend.textContent = "Extend Your Membership"
          }
        }
      } catch (err) {
        statusMessage.textContent = "Network error: " + err.message;
        purchaseBtn.disabled = true;
      }

      // Setup event listeners
      setupEventListeners();
      updateSubscriptionDisplay();
    });


    /* ================================================
       6) updateUIWithSubscription
       ================================================ */
       function updateUIWithSubscription(subData) {
        const endDateStr   = subData.endDate;
        const endDateObj   = new Date(endDateStr);
        const startDateStr = subData.startDate;
        const startDateObj = new Date(startDateStr);
        const now = new Date();

        // Ensure subStatus is visible
        subStatus.style.display = "block";

        // If the subscription hasn't ended yet:
        if (endDateObj > now) {
          planSelectionCard.style.display = "none";
          subStatus.classList.remove("alert-danger");
          subStatus.classList.add("alert-info");

          // (A) If active == true AND end date is in the future
          if (subData.active) {
            subStatus.textContent = `Your current ${subData.membershipType} Membership is active from ${startDateObj.toLocaleDateString()} until ${endDateObj.toLocaleDateString()}.`;
          }
          // (B) If active == false BUT end date is in the future
          else {
            subStatus.classList.remove("alert-info");
            subStatus.classList.add("alert-warning");
            subStatus.textContent = `Your ${subData.membershipType} Membership is still available until ${endDateObj.toLocaleDateString()}. You may re-activate your membership below.`;
          }

          if (subData.active) {
            // If the endDate is still in the future, membership is considered "active"
            const endDateObj = new Date(subData.endDate);
            const now = new Date();
            if (endDateObj > now) {
              cancelBtn.style.display = "block";
            } else {
              cancelBtn.style.display = "none";
            }
          } else {
            cancelBtn.style.display = "none";
          }
          
          // Hide the start-date group if the membership is still covering the user
          document.getElementById("startGroup").style.display = "none";
        }
        // Otherwise, it's expired
        else {
          planSelectionCard.style.display = "block";
          subStatus.classList.remove("alert-info");
          subStatus.classList.add("alert-danger");
          subStatus.textContent = `Your ${subData.membershipType} membership ended on ${endDateObj.toLocaleDateString()}. You may renew it below.`;
        }
      }


    /* ================================================
       7) setupEventListeners
       ================================================ */
    function setupEventListeners() {
      const planRadios = document.querySelectorAll('input[name="plan"]');
      planRadios.forEach(radio => {
        radio.addEventListener("change", updateSubscriptionDisplay);
      });
      monthsInput.addEventListener("change", updateSubscriptionDisplay);
      startInput.addEventListener("change", updateSubscriptionDisplay);

      purchaseBtn.addEventListener("click", onPurchaseClick);
      addCardBtn.addEventListener("click", () => {
        cardErrors.textContent = "";
        paymentModal.show();
      });

      paymentForm.addEventListener("submit", onPaymentFormSubmit);
            // Show the confirmation modal
      cancelBtn.addEventListener("click", () => {
        cancelModal.show();
      });
    }

    // If user confirms cancellation
    confirmCancelBtn.addEventListener("click", async () => {
      try {
        if (existingCustomerId) {
          // (1) Set "active" to false in Firebase
          await firebase.database().ref("subscriptions/" + existingCustomerId).update({
            active: false
          });

          // (2) Optionally display a quick message or toast
          statusMessage.textContent = "Membership has been canceled.";

          // (3) Hide the modal
          cancelModal.hide();

          // (4) Reload the page or redirect to reflect changes
          window.location.reload();
        }
      } catch (err) {
        console.error("Error canceling membership:", err);
        statusMessage.textContent = "Error canceling membership. Please try again.";
      }
    });


    /* ================================================
       8) updateSubscriptionDisplay
       ================================================ */
    function updateSubscriptionDisplay() {
      const planValue = getSelectedPlanAmount();
      let months = parseInt(monthsInput.value, 10) || 1;

      // user-chosen start
      let userSelectedDate = new Date(startInput.value);
      const now = new Date();

      // If current sub is still active, start after oldEnd
      if (currentSubscription && currentSubscription.endDate) {
        const subEnd = new Date(currentSubscription.endDate);
        if (subEnd > now && subEnd > userSelectedDate) {
          userSelectedDate = subEnd;
        }
      }

      // Enforce cap: compute how many months are allowed from the derived start/base date
      const msRemaining = MAX_END_DATE.getTime() - userSelectedDate.getTime();
      const allowedMonthsRaw = Math.floor(msRemaining / (30 * 86400000));
      const allowedMonths = Math.max(0, allowedMonthsRaw);
      const newMaxMonths = Math.min(8, allowedMonths);

      // If there is no room to extend at all, disable purchases and inform the user
      if (newMaxMonths < 1) {
        purchaseBtn.disabled = true;
        endDateDisplay.textContent = new Date(Math.min(MAX_END_DATE.getTime(), Math.max(userSelectedDate.getTime(), 0))).toLocaleDateString();
        totalCostEl.textContent = (planValue * Math.max(0, months)).toString();
        statusMessage.textContent = "Memberships cannot extend beyond Nov 16, 2025. No further extension is available.";
        return;
      }

      // Apply the dynamic max to months input and clamp current selection if needed
      monthsInput.max = String(newMaxMonths);
      if (months > newMaxMonths) {
        months = newMaxMonths;
        monthsInput.value = String(newMaxMonths);
      }

      // With clamped months, recompute total days and future date
      const totalDays = months * 30;
      durationDaysEl.textContent = totalDays.toString();
      const futureDate = new Date(userSelectedDate.getTime() + totalDays * 86400000);
      endDateDisplay.textContent = futureDate.toLocaleDateString();

      // total cost
      const totalCost = planValue * months;
      totalCostEl.textContent = totalCost.toString();
    }

    /* ================================================
       9) onPurchaseClick
       ================================================ */
    async function onPurchaseClick() {
      document.getElementById('purchaseBtn').textContent = 'Processing...';
      document.getElementById('purchaseBtn').disabled = true;
      const planValue = getSelectedPlanAmount();
      const months = parseInt(monthsInput.value, 10) || 1;
      const totalCost = planValue * months;

      if (!planValue) {
        statusMessage.textContent = "Please select a plan.";
        return;
      }
      if (!existingCustomerId) {
        statusMessage.textContent = "No Stripe customer found. Please add a card first.";
        return;
      }
      if (!defaultPaymentMethodId) {
        statusMessage.textContent = "No default card found. Please add one.";
        return;
      }

      // Validate against MAX_END_DATE before charging
      const now = new Date();
      let baseDate = new Date(startInput.value);
      if (currentSubscription && currentSubscription.endDate) {
        const oldEnd = new Date(currentSubscription.endDate);
        if (oldEnd > now && oldEnd > baseDate) {
          baseDate = oldEnd;
        }
      }
      const allowedMonths = Math.max(0, Math.floor((MAX_END_DATE.getTime() - baseDate.getTime()) / (30 * 86400000)));
      if (months > allowedMonths) {
        statusMessage.textContent = "Selected duration exceeds the maximum allowed. Memberships cannot extend beyond Nov 16, 2025.";
        document.getElementById('purchaseBtn').textContent = 'Confirm Purchase';
        document.getElementById('purchaseBtn').disabled = false;
        return;
      }

      await chargeSubscription(totalCost, planValue, months, defaultPaymentMethodId, existingCustomerId);
    }

    /* ================================================
       10) onPaymentFormSubmit
       ================================================ */
    async function onPaymentFormSubmit(e) {
      e.preventDefault();
      cardErrors.textContent = "";

      document.getElementById('submitBtn').textContent = 'Processing...';
      document.getElementById('submitBtn').disabled = true;

      const planValue = getSelectedPlanAmount();
      const months = parseInt(monthsInput.value, 10) || 1;
      const totalCost = planValue * months;

      if (!playerEmail) {
        cardErrors.textContent = "No playerEmail. Cannot proceed.";
        return;
      }
      const userName = nameInput.value || "Unnamed";

      // Validate against MAX_END_DATE before proceeding
      const now = new Date();
      let baseDate = new Date(startInput.value);
      if (currentSubscription && currentSubscription.endDate) {
        const oldEnd = new Date(currentSubscription.endDate);
        if (oldEnd > now && oldEnd > baseDate) {
          baseDate = oldEnd;
        }
      }
      const allowedMonths = Math.max(0, Math.floor((MAX_END_DATE.getTime() - baseDate.getTime()) / (30 * 86400000)));
      if (months > allowedMonths) {
        cardErrors.textContent = "Selected duration exceeds the maximum allowed. Memberships cannot extend beyond Nov 16, 2025.";
        document.getElementById('submitBtn').textContent = 'Add Card on File & Purchase';
        document.getElementById('submitBtn').disabled = false;
        return;
      }

      try {
        // (A) Create PaymentMethod
        const { paymentMethod, error } = await stripe.createPaymentMethod({
          type: "card",
          card: cardElement,
          billing_details: { name: userName, email: playerEmail }
        });
        if (error) {
          cardErrors.textContent = error.message;
          return;
        }

        // (B) If no Stripe customer, create
        if (!existingCustomerId) {
          const createResp = await fetch(createStripeUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: userName,
              email: playerEmail,
              paymentMethodId: paymentMethod.id
            })
          });
          const createData = await createResp.json();
          if (!createData.success) {
            cardErrors.textContent = createData.error || "Error creating Stripe customer.";
            return;
          }
          existingCustomerId = createData.customer.id;
          defaultPaymentMethodId = paymentMethod.id;
        } else {
          // (C) Attach PaymentMethod to existing
          const attachResp = await fetch(attachStripeUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              customerId: existingCustomerId,
              paymentMethodId: paymentMethod.id
            })
          });
          const attachData = await attachResp.json();
          if (!attachData.success) {
            cardErrors.textContent = attachData.error || "Error attaching card.";
            return;
          }
          defaultPaymentMethodId = paymentMethod.id;
        }

        // (D) Charge
        await chargeSubscription(totalCost, planValue, months, paymentMethod.id, existingCustomerId);

        // (E) Close modal
        paymentModal.hide();
      } catch (err) {
        cardErrors.textContent = err.message || "Unknown error while creating PaymentMethod.";
      }
    }

    /* ================================================
       11) chargeSubscription
       ================================================ */
    async function chargeSubscription(
      amountInDollars,
      planValue,
      months,
      paymentMethodId,
      customerId
    ) {
      const amountInCents = amountInDollars * 100;
      statusMessage.textContent = "Processing...";

      try {
        // (A) Create PaymentIntent
        const resp = await fetch(chargeOneTimeWithCustomerUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: amountInCents,
            paymentMethodId,
            customerId
          })
        });
        const data = await resp.json();
        if (!data.success) {
          statusMessage.textContent = "Error creating PaymentIntent: " + data.error;
          return;
        }

        // (B) Confirm on client
        statusMessage.textContent = "Confirming Payment...";
        const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret);
        if (confirmError) {
          statusMessage.textContent = "Payment failed: " + confirmError.message;
          return;
        }

        // (C) Payment succeeded
        const totalDays = months * 30;
        statusMessage.textContent = `Success! Charged $${amountInDollars}. Your membership is now active!`;

        // (C1) membership type
        let membershipType = "Silver";
        if (planValue === 175) membershipType = "Gold";
        else if (planValue === 499) membershipType = "TripleCrown";

        // (C2) finalStartDate
        let finalStartDate = new Date(document.getElementById("startDateInput").value);
        const now = new Date();
        if (currentSubscription && currentSubscription.endDate) {
          const oldEnd = new Date(currentSubscription.endDate);
          const oldStart= new Date(currentSubscription.startDate || now);
          if (oldEnd > now) {
            // still active => keep oldStart
            finalStartDate = oldStart;
          }
        }

        // (C3) endDate
        let finalEndDate;
        if (currentSubscription && currentSubscription.endDate) {
          const oldEnd = new Date(currentSubscription.endDate);
          if (oldEnd > now) {
            finalEndDate = new Date(oldEnd.getTime() + totalDays * 86400000);
          } else {
            finalEndDate = new Date(finalStartDate.getTime() + totalDays * 86400000);
          }
        } else {
          finalEndDate = new Date(finalStartDate.getTime() + totalDays * 86400000);
        }

        // (C3b) Safety clamp: do not allow beyond MAX_END_DATE
        if (finalEndDate.getTime() > MAX_END_DATE.getTime()) {
          finalEndDate = new Date(MAX_END_DATE.getTime());
        }

        // (C4) Update Firebase
        firebase
          .database()
          .ref("subscriptions/" + customerId)
          .set({
            email: playerEmail,
            customerId,
            membershipType,
            rate: planValue,
            startDate: finalStartDate.toISOString(),
            endDate: finalEndDate.toISOString(),
            active: true
          });

        currentSubscription = {
          email: playerEmail,
          customerId,
          membershipType,
          startDate: finalStartDate.toISOString(),
          endDate: finalEndDate.toISOString(),
          active: true
        };
        updateUIWithSubscription(currentSubscription);

        // (D) Show success modal
        const successModalEl = document.getElementById("successModal");
        const successModal    = new bootstrap.Modal(successModalEl);
        successModal.show();

        // (D1) If forcibly closed => redirect
        successModalEl.addEventListener("hide.bs.modal", () => {
          window.location.href = "index.html";
        });

        // (D2) If user clicks OK => redirect
        const successOkBtn = document.getElementById("successOkBtn");
        successOkBtn.addEventListener("click", () => {
          window.location.href = "index.html";
        });

      } catch (err) {
        statusMessage.textContent = "Network/Server error: " + err.message;
      }
    }

    /* Get selected plan amount */
    function getSelectedPlanAmount() {
  // If the user has a current subscription that hasn't ended:
  if (
    currentSubscription && 
    new Date(currentSubscription.endDate) > new Date()
  ) {
    // Keep the same plan as their existing membership
    switch (currentSubscription.membershipType) {
      case "Gold":
        return 175;
      case "TripleCrown":
        return 499;
      default:
        return 99; // default to Silver if none matched
    }
  }

  // Otherwise, user is either new or expired: read whichever radio they picked
  const planRadios = document.querySelectorAll('input[name="plan"]');
  for (let r of planRadios) {
    if (r.checked) {
      return parseInt(r.value, 10);
    }
  }
  return 99; // fallback
}

  </script>
</body>
</html>
