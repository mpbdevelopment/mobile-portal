<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" name="theme-color" content="#0e2f7b" />
  <title>Montclair Pickleball Player Portal</title>
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <link rel="manifest" href="manifest.json">

  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.4/index.global.min.js"></script>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <link rel="icon" href="icons/icon-192x192.png">

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(registration => console.log('Service Worker registered:', registration))
        .catch(error => console.error('Service Worker registration failed:', error));
    }
  </script>

  <!-- IMPORTANT: Use viewport-fit=cover for iPhone safe-area -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <style>
    /* 1) Remove default margin on body and add padding for iPhone safe-area */
    body {
      margin: 0;
      padding-bottom: calc(80px + env(safe-area-inset-bottom));
      background-color: #f9f9f9;
    }

    /*Brand color as the primary background and buttons */
    .bg-primary {
      background-color: #0e2f7b !important;
    }

    .btn-primary {
      background-color: #0e2f7b !important;
      border-color: #0e2f7b !important;
    }

    .btn-primary:hover,
    .btn-primary:focus,
    .btn-primary:active {
      background-color: #0c2563 !important; /* Slightly darker shade for hover/focus */
      border-color: #0c2563 !important;
    }

    /* 2) Fixed bottom nav with safe-area padding. Also highlight the active link with a background color. */
    .nav-bottom {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding-bottom: env(safe-area-inset-bottom);
      background-color: #fff;
      border-top: 1px solid #ddd;
      z-index: 999;
      display: flex;
    }
    .nav-bottom .nav-link {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      color: #000;
    }
    .nav-bottom .nav-link.active {
      background-color: #0e2f7b; /* Bootstrap primary color */
      color: #fff;              /* White text for contrast */
      font-weight: 500;
    }

    .tab-content {
      padding: 1rem;
    }

    /* Hide main tab content until user is verified */
    #tab-content-section {
      display: none;
    }

    /* Email verification UI */
    #verification-section {
      display: none; 
      max-width: 500px;
      margin: 30px auto;
      padding: 20px;
      background: #fff;
      border-radius: 5px;
    }
    .card-errors {
      color: red;
    }

    /* Profile container with a spinner overlay */
    #profile-container {
      position: relative; 
    }
    #profile-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      display: none; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #profile-content {
      display: none; 
    }

    .session-card.selected-session {
    border: 2px solid green; 
    background-color: #e6f7e8; /* a light greenish background to match your existing style */
    transform: scale(1);
    opacity: 1;
    }


    /* Register tab container with a spinner overlay */
    #register-container {
      position: relative; 
    }
    /* Spinner overlay for Payment Processing */
    #payment-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    /* Spinner overlay for Session Loading */
    #session-spinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    #payment-success {
      display: none; 
      margin-top: 10px;
    }

    /* My Registrations container */
    #registrations-container {
      position: relative;
    }
    #registrations-spinner {
      display: none;
      background: #fff; 
      text-align: center;
    }
    #registrations-content {
      display: none;
    }

    /* Program listing & cart are replaced by a new card layout
       but keep them hidden or repurposed as needed. */

    /* [CHANGED] Hide the old #products-section & #cart-section by default (we'll re-use some logic) */
    #products-section {
      display: none;
    }
    #cart-section {
      display: none;
    }

    /* For "Amount Due" and breakdown lines */
    #amount-due-line {
      margin-top: 8px;
      font-size: 1.1rem;
      font-weight: bold;
    }
    #breakdown-line {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }

    .text-primary {
      color: #0e2f7b !important;
    }

    /* [CHANGED] Session Cards Container */
    #session-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .session-card {
      flex: 1 1 200px; /* responsive sizing */
      min-width: 200px;
      max-width: 300px;
      transition: transform 0.3s, opacity 0.3s;
    }

    .session-card.non-selected-session {
      transform: scale(0.9);
      opacity: 0.7;
    }

    @media (max-width: 576px) {
  .session-card .card-body {
    padding: 0.75rem;
    font-size: 0.9rem;
  }
  .session-card h6 {
    font-size: 1rem;
  }
}

    /* [CHANGED] Hide filters initially (progressive) */
    #filter-section {
      display: none;
      margin-bottom: 1rem;
    }

    /* [CHANGED] Program Cards Container */
    #program-cards-container {
      display: none; /* shown only once filters are all selected */
      gap: 1rem;
      flex-wrap: wrap;
    }

    .badges .badge {
    margin-bottom: 0.25rem;  /* small spacing between badges */
    margin-right: 0.25rem

    }


    .program-card {
      width: 100%;
      max-width: 300px;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 1rem;
      background: #fff;
      position: relative;
    }
    .program-card .program-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .program-card .program-price {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .program-card .badges {
      margin-bottom: 0.5rem;
    }

    /* [CHANGED] "Added" state styling */
    .program-card.added {
      background-color: #e6f7e8; /* light greenish */
      border-color: #81c784;    /* greener border */
    }

    .program-card.added .btn-add {
      display: none;
    }
    .program-card.added .added-controls {
      display: block;
    }
    .added-controls {
      display: none;
    }

    /* [CHANGED] Floating Cart Pill */
    #cart-summary-pill {
      position: fixed;
      bottom: 80px; /* just above the nav */
      right: 15px;
      z-index: 9999;
      background: #0e2f7b;
      color: #fff;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-light">

  <!-- HEADER -->
  <header 
    class="text-white p-3 mb-2 d-flex align-items-center justify-content-between" 
    style="background-color: #0e2f7b;"
  >
    <h4 class="mb-0">MP Player Portal</h4>
    <img 
      src="icons/banner-logo.png" 
      alt="Logo" 
      style="height: 40px;"
    >
  </header>

  <!-- EMAIL VERIFICATION SECTION (Only for first-time devices) -->
  <section id="verification-section" class="shadow-sm">
    <h5>Verify Your Email</h5>
    <p>Enter your email to receive a 6-digit code.</p>
    <form id="verification-form">
      <div class="mb-3">
        <label for="verify-email-input" class="form-label">Email Address</label>
        <input type="text" class="form-control" id="verify-email-input" required />
      </div>
      <button type="submit" class="btn btn-primary w-100 mb-2">
        Send Verification Code
      </button>
      <a href="registration.html" class="btn btn-secondary">Register New User</a>
    </form>

    <div id="code-entry" style="display: none;">
      <p>Enter the 6-digit code we sent to your email:</p>
      <div class="mb-3">
        <input type="text" class="form-control" id="verify-code-input" placeholder="123456" />
      </div>
      <button id="verify-code-button" class="btn btn-secondary w-100">
        Verify Code
      </button>
    </div>
  </section>

  <!-- MAIN TAB CONTENT (Once verified) -->
  <section id="tab-content-section">
    <div class="tab-content" id="myTabContent">

      <!-- PROFILE TAB -->
      <div class="tab-pane fade show active" id="tab-profile" role="tabpanel">
        <div class="bg-white p-3 rounded shadow-sm" id="profile-container">
          
          <!-- Spinner Overlay (centered) -->
          <div id="profile-spinner">
            <div class="text-center">
              <div class="spinner-border text-primary mb-2" role="status"></div>
              <p class="mb-0">Logging you in!</br>This may take up to 20 seconds...</p>
            </div>
          </div>

          <!-- Actual Profile Content -->
          <div id="profile-content">
            <h5>Profile</h5>
            <p><strong>First Name:</strong> <span id="profile-first-name"></span></p>
            <p><strong>Last Name:</strong> <span id="profile-last-name"></span></p>
            <p><strong>Phone:</strong> <span id="profile-phone"></span></p>
            <p><strong>Email:</strong> <span id="profile-email"></span></p>
            <p><strong>Card on File:</strong>
                <span id="profile-card-last4">No card on file</span>
                <!-- We'll show/hide or change the text on this button in JS -->
                <button id="profile-card-button" 
                        class="btn btn-sm btn-outline-secondary ms-2" 
                        style="display: none;">
                </button>
            </p>              
            <!-- Display user credit from PromoCodes -->
            <p><strong>Credit:</strong> <span id="profile-credit-amount">No credit available</span></p>

            <button id="logout-button" class="btn btn-danger w-100 mt-3">Logout</button>
          </div>
        </div>
      </div>

      <!-- REGISTER TAB -->
      <div class="tab-pane fade" id="tab-register" role="tabpanel">
        <div class="bg-white p-3 rounded shadow-sm position-relative" id="register-container">
          
          <!-- Session Loading Spinner -->
          <div id="session-spinner">
            <div class="text-center">
              <div class="spinner-border text-primary mb-2" role="status"></div>
              <p class="mb-0">Loading Session...</p>
            </div>
          </div>

          <!-- Payment Spinner overlay while processing payment -->
          <div id="payment-spinner">
            <div class="text-center">
              <div class="spinner-border text-primary mb-2" role="status"></div>
              <p class="mb-0">Processing Payment...</p>
            </div>
          </div>

          <!-- Payment success alert (may show credit left) -->
          <div id="payment-success" class="alert alert-success" role="alert">
            Payment processed successfully! Your registration has been submitted.
          </div>

          <h5>Select a Location/Session</h5>

          <!-- [CHANGED] 1) Session Cards Container -->
          <div id="session-cards" class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-1">
            <!-- Dynamically populated in loadSessions() -->
          </div>

          <!-- [CHANGED] 2) Filter Section (Progressive) -->
          <div id="filter-section">
            <!-- We still use the same 3 filters, but they appear one at a time. -->

            <!-- [ADDED] Toggle Calendar/List Button & List-View Container (initially hidden) -->
<div class="d-flex justify-content-end mb-3" id="toggle-view-container" style="display: none;">
    <button id="btn-toggle-calendar-view" class="btn btn-outline-primary btn-sm">Toggle Calendar View</button>
  </div>
  
  <!-- [ADDED] List View Container (7-day list) -->
  <div id="list-view-container" style="display: none;">
    <div id="standardized-level-filter-group" style="display: none;">
        <label class="form-label"><strong>Filter By Your Level</strong></label>
        <select id="standardized-level-filter" class="form-select mb-3">
          <option value="">--All Levels--</option>
        </select>
      </div>      
    <div class="d-flex justify-content-between align-items-center mb-2">
      <button id="btn-list-prev" class="btn btn-sm btn-secondary">&laquo; Previous 7 Days</button>
      <button id="btn-list-next" class="btn btn-sm btn-secondary">Next 7 Days &raquo;</button>
    </div>
    <div id="program-list-content"></div>
  </div>
  
            
            <!-- Category Filter -->
            <div id="category-filter-group" style="display: none;">
              <label class="form-label"><strong>Select Program</strong></label>
              <select id="category-filter" class="form-select mb-3">
                <option value="">--All Categories--</option>
              </select>
            </div>

            <!-- Level Filter -->
            <div id="level-filter-group" style="display: none;">
              <label class="form-label"><strong>Select Level</strong></label>
              <select id="level-filter" class="form-select mb-3">
                <option value="">--All Levels--</option>
              </select>
            </div>

            <!-- Day/Time Filter -->
            <div id="daytime-filter-group" style="display: none;">
              <label class="form-label"><strong>Select Day/Time</strong></label>
              <select id="daytime-filter" class="form-select mb-3">
                <option value="">--All Day/Times--</option>
              </select>
            </div>
          </div>

          <!-- [CHANGED] 3) Program Cards Container -->
          <div id="program-cards-container"></div>

          <!-- The old cart-section is still in code, but hidden. We'll keep the logic for payment. -->
          <hr/>
          <div id="cart-section" style="display: none;">
            <h6>Your Cart</h6>
            <table class="table table-striped table-sm" id="cart-table">
              <thead>
                <tr>
                  <th>Program</th>
                  <th>Session</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          
            <div id="amount-due-line"></div>
            <div id="breakdown-line"></div>
          
            <!-- TWO buttons -->
            <div class="d-flex gap-2 mt-3">
              <!-- 1) Charge On-File -->
              <button id="btn-charge-on-file" class="btn btn-primary flex-fill">
                Charge Card on File
              </button>
          
              <!-- 2) One-Time Payment -->
              <button id="btn-credit-debit" class="btn btn-secondary flex-fill">
                Credit/Debit Card
              </button>
            </div>
          </div>          

        </div>
      </div>

      <!-- MY REGISTRATIONS TAB -->
      <div class="tab-pane fade" id="tab-registrations" role="tabpanel">
        <div class="bg-white p-3 rounded shadow-sm position-relative" id="registrations-container">
          <h5>My Registrations</h5>

          <div id="registrations-spinner">
            <div class="spinner-border text-primary mb-2" role="status"></div>
            <p class="mb-0">Loading Registrations...</p>
          </div>
          <div id="registrations-content">
            <div id="calendar"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FIXED BOTTOM NAV -->
  <nav class="nav nav-bottom d-flex justify-content-around">
    <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-profile" role="tab">
      <span class="d-block">Profile</span>
    </a>
    <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-register" role="tab">
      <span class="d-block">Register</span>
    </a>
    <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-registrations" role="tab">
      <span class="d-block">My Registrations</span>
    </a>
  </nav>

  <!-- PAYMENT MODAL -->
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Payment Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Please add a payment method to continue.</p>
          <form id="payment-form">
            <div class="mb-3">
              <label for="name-input" class="form-label">Name</label>
              <input type="text" class="form-control" id="name-input" required />
            </div>
            <div class="mb-3">
              <label for="card-element" class="form-label">Card</label>
              <div id="card-element" class="form-control"></div>
              <div id="card-errors" class="card-errors"></div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Payment Profile</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ONE-TIME PAYMENT MODAL -->
  <div class="modal fade" id="oneTimePaymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pay with Credit/Debit Card</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Please enter your card details to complete the payment. This card will <strong>not</strong> be saved on file.</p>
          <form id="one-time-payment-form">
            <div class="mb-3">
              <label for="otpf-name" class="form-label">Name on Card</label>
              <input type="text" class="form-control" id="otpf-name" required />
            </div>
            <div class="mb-3">
              <label for="otpf-card-element" class="form-label">Card</label>
              <div id="otpf-card-element" class="form-control"></div>
              <div id="otpf-card-errors" class="card-errors text-danger mt-1"></div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Pay Now</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- [CHANGED] Floating Cart Summary Pill -->
  <div id="cart-summary-pill" style="display: none;">0 items - $0.00</div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************************************************************
     * 1) CONFIG & STRIPE SETUP
     ************************************************************/
    const GAS_PROXY         = 'https://merry-rugelach-c028d1.netlify.app/.netlify/functions/proxy';
    const FIND_STRIPE_URL   = 'https://merry-rugelach-c028d1.netlify.app/.netlify/functions/findStripe';
    const CREATE_STRIPE_URL = 'https://merry-rugelach-c028d1.netlify.app/.netlify/functions/createStripe';
    const CHARGE_CART_URL   = 'https://merry-rugelach-c028d1.netlify/functions/chargeCart';
    const GET_CREDIT_URL    = 'https://merry-rugelach-c028d1.netlify.app/.netlify/functions/proxy?action=getCredit';

    const stripe = Stripe('pk_live_51N9BzSHaWNal9rme3vwhLRs3vRgdqPQO35KZ2WQHPvefzbh2dP1VRCLTc8wKBNxN3jk8VXkeu8P3MJxnoJ1A3JaP00OotZGNnb');
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    // Create a second Elements instance
    const oneTimeElements = stripe.elements();
    const oneTimeCard = oneTimeElements.create('card');
    oneTimeCard.mount('#otpf-card-element'); // "otpf" = One-Time Payment Form

    const ADMIN_PASSWORD = 'password';

    let currentPlayer = null; 
    let allSessions = [];   // holds full data for all sessions
    let cartItems = [];

    // We'll keep track of the currently selected session, category, level, dayTime
    let selectedSession = null;
    let selectedCategory = null;
    let selectedLevel = null;
    let selectedDayTime = null;
    let selectedStandardizedLevel = null;


    // We'll keep a global array of "allProducts" for the chosen session
    let allProducts = [];

    // Globals for the “Toggle Calendar View” / 7-day listing
    let isListView = false;          // Tracks if we are currently in "list view"
    let listViewStartDate = null;    // Start date for the current 7-day range
    let minProgramDate = null;       // Earliest date in the selected session's programs
    let maxProgramDate = null;       // Latest date in the selected session's programs

    document.getElementById('cart-summary-pill').addEventListener('click', () => {
    window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
    });
    });


    /************************************************************
     * 2) ON PAGE LOAD
     ************************************************************/
    window.addEventListener('DOMContentLoaded', () => {
      const storedEmail = localStorage.getItem('playerEmail');
      if (storedEmail) {
        showMessage(`LocalStorage email found: ${storedEmail}`, 'debug');
        document.getElementById('tab-content-section').style.display = 'block';
        initiateValidationFlow(storedEmail);
      } else {
        showMessage('No stored email found; showing verification UI.', 'debug');
        document.getElementById('verification-section').style.display = 'block';
      }
    });

    /************************************************************
     * 3) SPINNER LOGIC
     ************************************************************/
    function showProfileSpinner(shouldShow) {
      const spinner = document.getElementById('profile-spinner');
      const profileContent = document.getElementById('profile-content');
      if (!spinner || !profileContent) return;
      spinner.style.display = shouldShow ? 'block' : 'none';
      profileContent.style.display = shouldShow ? 'none' : 'block';
    }

    function showPaymentSpinner(shouldShow) {
      const spinner = document.getElementById('payment-spinner');
      const successBox = document.getElementById('payment-success');
      if (!spinner || !successBox) return;
      spinner.style.display = shouldShow ? 'block' : 'none';
      if (shouldShow) successBox.style.display = 'none';
    }

    function showSessionSpinner(shouldShow) {
      const spinner = document.getElementById('session-spinner');
      if (!spinner) return;
      spinner.style.display = shouldShow ? 'block' : 'none';
    }

    function showRegistrationsSpinner(shouldShow) {
      const spinner = document.getElementById('registrations-spinner');
      const content = document.getElementById('registrations-content');
      if (!spinner || !content) return;
      spinner.style.display = shouldShow ? 'block' : 'none';
      content.style.display = shouldShow ? 'none' : 'block';
    }

    function showPaymentSuccess(shouldShow) {
      const successBox = document.getElementById('payment-success');
      if (!successBox) return;
      successBox.style.display = shouldShow ? 'block' : 'none';
    }

    /************************************************************
     * 4) EMAIL VERIFICATION
     ************************************************************/
    document.getElementById('verification-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const rawInput = document.getElementById('verify-email-input').value.trim();
      if (!rawInput) return;

      let isAdminLogin = false;
      let adminEmail    = '';
      let adminPassword = '';

      if (rawInput.includes('?')) {
        const parts = rawInput.split('?');
        adminEmail    = parts[0].trim().toLowerCase();
        adminPassword = parts[1].trim();
        if (adminPassword === ADMIN_PASSWORD) {
          isAdminLogin = true;
        }
      }

      if (isAdminLogin) {
        // Admin login bypass
        showMessage('Admin login detected. Checking if user exists...', 'info');
        const playerUrl = `${GAS_PROXY}?action=getPlayerInfo&email=${encodeURIComponent(adminEmail)}`;
        try {
          const playerResp = await fetch(playerUrl);
          const playerData = await playerResp.json();
          if (!playerData.success || !playerData.player) {
            alert('Error: That email does not exist in the system.');
            return;
          }
          document.getElementById('verification-section').style.display = 'none';
          document.getElementById('tab-content-section').style.display = 'block';
          initiateValidationFlow(adminEmail);
        } catch (err) {
          alert('Network error checking player info: ' + err.message);
          return;
        }
      } else {
        // Normal user flow
        const emailInput = rawInput.toLowerCase();
        showMessage(`Sending verification code for email: ${emailInput}`, 'debug');

        const url = `${GAS_PROXY}?action=sendVerificationEmail&email=${encodeURIComponent(emailInput)}`;
        try {
          const resp = await fetch(url);
          const data = await resp.json();
          if (data.success) {
            window.__verificationCode = data.code;
            document.getElementById('code-entry').style.display = 'block';
            showMessage(`(Debug) Verification code is: ${data.code}`, 'debug');
          } else {
            alert('Error sending code: ' + (data.error || 'Unknown'));
          }
        } catch (err) {
          alert('Network error: ' + err.message);
        }
      }
    });

    document.getElementById('verify-code-button').addEventListener('click', () => {
      const userCode = document.getElementById('verify-code-input').value.trim();
      const actualCode = window.__verificationCode;
      if (userCode === actualCode) {
        const verifiedEmail = document.getElementById('verify-email-input').value.trim().toLowerCase();
        localStorage.setItem('playerEmail', verifiedEmail);

        alert('Email verified!');
        document.getElementById('verification-section').style.display = 'none';
        document.getElementById('tab-content-section').style.display = 'block';
        initiateValidationFlow(verifiedEmail);
      } else {
        alert('Invalid code. Please check your email or resend.');
      }
    });

    /************************************************************
     * 5) INITIATE VALIDATION FLOW (Players + Stripe + Credit)
     ************************************************************/
    async function initiateValidationFlow(email) {
      showMessage(`initiateValidationFlow for email: ${email}`, 'debug');
      showProfileSpinner(true);

      try {
        // 1) getPlayerInfo
        const playerUrl = `${GAS_PROXY}?action=getPlayerInfo&email=${encodeURIComponent(email)}`;
        const playerResp = await fetch(playerUrl);
        const playerData = await playerResp.json();
        showMessage(`playerData: ${JSON.stringify(playerData)}`, 'debug');

        if (!playerData.success || !playerData.player) {
          showMessage(`Error retrieving or invalid player: ${playerData.error}`, 'error');
          showProfileSpinner(false);
          return;
        }
        currentPlayer = playerData.player;

        // 2) Check Stripe
        const stripeUrl = `${FIND_STRIPE_URL}?email=${encodeURIComponent(email)}`;
        const stripeResp = await fetch(stripeUrl);
        const stripeData = await stripeResp.json();
        showMessage(`stripeData: ${JSON.stringify(stripeData)}`, 'debug');

        if (!stripeData.success) {
          showMessage('Error checking Stripe: ' + (stripeData.error || ''), 'error');
          showProfileSpinner(false);
          return;
        }
        if (stripeData.exists) {
          currentPlayer.cardLast4 = stripeData.cardLast4 || null;
        } else {
          showMessage('No Stripe customer found => Payment Profile needed', 'debug');
        }

        // 3) Fetch user credit
        const creditUrl = `${GET_CREDIT_URL}&email=${encodeURIComponent(email)}`;
        const creditResp = await fetch(creditUrl);
        const creditData = await creditResp.json();
        showMessage(`creditData: ${JSON.stringify(creditData)}`, 'debug');
        currentPlayer.credit = creditData.success ? (creditData.credit || 0) : 0;

        // Show profile
        setProfileData(currentPlayer);

        // If no stripe => show modal
        if (!stripeData.exists) {
          const modalEl = new bootstrap.Modal(document.getElementById('paymentModal'));
          modalEl.show();
        } else {
          // Load sessions
          showSessionSpinner(true);
          await loadSessions();
          showSessionSpinner(false);
        }

        showProfileSpinner(false);
      } catch (err) {
        showMessage('initiateValidationFlow error: ' + err.message, 'error');
        showProfileSpinner(false);
        showSessionSpinner(false);
      }
    }

    /************************************************************
     * 6) PAYMENT PROFILE FORM
     ************************************************************/
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nameInput = document.getElementById('name-input').value.trim();
      const email = currentPlayer?.email || '';

      showMessage(`Creating PaymentMethod for email: ${email}`, 'debug');
      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: 'card',
        card: cardElement,
        billing_details: { name: nameInput, email }
      });
      if (error) {
        showMessage('Stripe error: ' + error.message, 'error');
        return;
      }
      showMessage(`PaymentMethod created: ${paymentMethod.id}`, 'debug');

      const payload = { name: nameInput, email, paymentMethodId: paymentMethod.id };
      try {
        const resp = await fetch(CREATE_STRIPE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        showMessage(`createStripe response: ${JSON.stringify(data)}`, 'debug');

        if (!data.success) {
          showMessage('Error creating Stripe customer: ' + (data.error || ''), 'error');
          return;
        }
        showMessage('Payment profile created successfully!', 'success');

        const modalEl = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
        modalEl.hide();

        showSessionSpinner(true);
        await loadSessions();
        showSessionSpinner(false);
      } catch (err) {
        showMessage('Payment profile error: ' + err.message, 'error');
      }
    });

    /************************************************************
     * 7) LOAD SESSIONS -> DISPLAY AS CARDS
     ************************************************************/
    async function loadSessions() {
      showMessage('Loading sessions from getSessions', 'debug');
      try {
        const url = `${GAS_PROXY}?action=getSessions`;
        const resp = await fetch(url);
        const data = await resp.json();

        if (!data.success) {
          showMessage('Error loading sessions: ' + data.error, 'error');
          return;
        }
        const sessionInfos = data.sessions || [];
        // For each session, fetch programs
        const sessionPromises = sessionInfos.map(sess => fetchProgramsForSession(sess));
        const results = await Promise.all(sessionPromises);
        allSessions = results; 
        // Now display them as cards:
        displaySessionCards(allSessions);
      } catch (err) {
        showMessage('Session load error: ' + err.message, 'error');
      }
    }

    async function fetchProgramsForSession(sess) {
      const programUrl = `${GAS_PROXY}?action=getProgramList&sessionId=${encodeURIComponent(sess.spreadsheetId)}`;
      const resp = await fetch(programUrl);
      const data = await resp.json();
      if (!data.success) {
        showMessage('Error loading programs for ' + sess.spreadsheetId, 'error');
        return { ...sess, products: [] };
      }
      return {
        ...sess,
        products: data.products || []
      };
    }

function displaySessionCards(sessions) {
  const container = document.getElementById('session-cards');
  container.innerHTML = '';

  if (!sessions || !sessions.length) {
    container.innerHTML = '<p>No sessions found.</p>';
    return;
  }

  // Simply loop through sessions in their original order
  sessions.forEach(sessionObj => {
    const label = `${sessionObj.location} - ${sessionObj.season}`;

    // Create a column for each session
    const colDiv = document.createElement('div');
    // Adjust col sizes to your preference
    colDiv.classList.add('col-12','col-sm-6','col-md-4','col-lg-3','mb-3');

    // Card wrapper
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card session-card h-100'; 
    // If it's the currently selected session, highlight it
    if (selectedSession && sessionObj.spreadsheetId === selectedSession.spreadsheetId) {
      cardDiv.classList.add('selected-session');
    }

    // Card body
    const cardBody = document.createElement('div');
    cardBody.className = 'card-body';

    // Title
    const titleEl = document.createElement('h6');
    titleEl.classList.add('card-title','mb-2');
    titleEl.textContent = label;

    // Button
    const selectBtn = document.createElement('button');
    selectBtn.classList.add('btn','btn-sm');
    if (selectedSession && sessionObj.spreadsheetId === selectedSession.spreadsheetId) {
      selectBtn.textContent = 'Selected';
      selectBtn.classList.add('btn-success');
    } else {
      selectBtn.textContent = 'Select';
      selectBtn.classList.add('btn-primary');
    }

    // Handle click => set selectedSession, then re-display
    selectBtn.addEventListener('click', () => {
      selectedSession = sessionObj;
      allProducts     = sessionObj.products || [];

      // Re-render the session cards so we highlight the new selection
      displaySessionCards(sessions);

      // Continue your existing logic
      resetProductFilters();
      prepareListViewDates(sessionObj);
      populateStandardizedLevelDropdown();

      const progContainer = document.getElementById('program-cards-container');
      progContainer.style.display = 'none';

      if (isListView) {
        showFilterStep(0);
        updateRegisterViewMode();
      } else {
        showFilterStep(1);
      }
      showToggleCalendarButton(true);
    });

    // Assemble the card
    cardBody.appendChild(titleEl);
    cardBody.appendChild(selectBtn);
    cardDiv.appendChild(cardBody);
    colDiv.appendChild(cardDiv);
    container.appendChild(colDiv);
  });
}



    /************************************************************
     * 8) FILTERS => PROGRESSIVE
     ************************************************************/
    function showFilterStep(step) {
      const filterSection = document.getElementById('filter-section');
      const catGroup      = document.getElementById('category-filter-group');
      const lvlGroup      = document.getElementById('level-filter-group');
      const dtGroup       = document.getElementById('daytime-filter-group');
      const progContainer = document.getElementById('program-cards-container');

      if (step === 0) {
        // We comment out hiding the entire filterSection to keep the toggle visible
        // filterSection.style.display  = 'none'; 
        catGroup.style.display       = 'none';
        lvlGroup.style.display       = 'none';
        dtGroup.style.display        = 'none';
        progContainer.style.display  = 'none';
        return;
      }

      filterSection.style.display = 'block';
      if (step === 1) {
        catGroup.style.display      = 'block';
        lvlGroup.style.display      = 'none';
        dtGroup.style.display       = 'none';
        progContainer.style.display = 'none';
      } else if (step === 2) {
        lvlGroup.style.display      = 'block';
        dtGroup.style.display       = 'none';
        progContainer.style.display = 'none';
      } else if (step === 3) {
        dtGroup.style.display       = 'block';
        progContainer.style.display = 'none';
      } else if (step === 4) {
        // Only show program cards if day/time is selected
        progContainer.style.display = 'flex';
      }
    }

    function resetProductFilters() {
      selectedCategory = null;
      selectedLevel    = null;
      selectedDayTime  = null;
      selectedStandardizedLevel = null;


      const catSelect = document.getElementById('category-filter');
      catSelect.innerHTML = '<option value="">--All Categories--</option>';

      if (!allProducts.length) {
        showFilterStep(0);
        return;
      }

      // Populate categories
      const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        catSelect.appendChild(opt);
      });

      document.getElementById('level-filter').innerHTML    = '<option value="">--All Levels--</option>';
      document.getElementById('daytime-filter').innerHTML  = '<option value="">--All Day/Times--</option>';

      showFilterStep(1);
    }

    document.getElementById('category-filter').addEventListener('change', () => {
      selectedCategory = document.getElementById('category-filter').value.trim();
      let filtered = selectedCategory
        ? allProducts.filter(p => p.category === selectedCategory)
        : allProducts;

      document.getElementById('program-cards-container').innerHTML = '';
      document.getElementById('program-cards-container').style.display = 'none';

      const levelSelect = document.getElementById('level-filter');
      levelSelect.innerHTML = '<option value="">--All Levels--</option>';
      const levels = [...new Set(filtered.map(p => p.level).filter(Boolean))];
      levels.forEach(lv => {
        const opt = document.createElement('option');
        opt.value = lv;
        opt.textContent = lv;
        levelSelect.appendChild(opt);
      });
      showFilterStep(2);
    });

    document.getElementById('level-filter').addEventListener('change', () => {
      selectedLevel = document.getElementById('level-filter').value.trim();

      document.getElementById('program-cards-container').innerHTML = '';
      document.getElementById('program-cards-container').style.display = 'none';

      let filtered = allProducts;
      if (selectedCategory) filtered = filtered.filter(p => p.category === selectedCategory);
      if (selectedLevel)    filtered = filtered.filter(p => p.level === selectedLevel);

      // populate day/time
      const dtSelect = document.getElementById('daytime-filter');
      dtSelect.innerHTML = '<option value="">--All Day/Times--</option>';
      const dayTimes = [...new Set(filtered.map(p => p.dayTime).filter(Boolean))];
      dayTimes.forEach(dt => {
        const opt = document.createElement('option');
        opt.value = dt;
        opt.textContent = dt;
        dtSelect.appendChild(opt);
      });
      showFilterStep(3);
    });

    document.getElementById('daytime-filter').addEventListener('change', () => {
      selectedDayTime = document.getElementById('daytime-filter').value.trim();
      renderProgramCards();
      showFilterStep(4);
    });

    function renderProgramCards() {
      const container = document.getElementById('program-cards-container');
      container.innerHTML = '';

      let filtered = allProducts;
      if (selectedCategory) filtered = filtered.filter(p => p.category === selectedCategory);
      if (selectedLevel)    filtered = filtered.filter(p => p.level === selectedLevel);
      if (selectedDayTime)  filtered = filtered.filter(p => p.dayTime === selectedDayTime);

      if (!filtered.length) {
        container.innerHTML = '<p>No programs match these filters.</p>';
        return;
      }

      filtered.forEach(prod => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'program-card';

        const inCart = cartItems.find(ci => ci.program === prod.program && ci.sessionId === selectedSession.spreadsheetId);
        if (inCart) {
          cardDiv.classList.add('added');
        }

        const nameEl = document.createElement('div');
        nameEl.className = 'program-name';
        nameEl.textContent = prod.program;

        const priceEl = document.createElement('div');
        priceEl.className = 'program-price';
        priceEl.textContent = `$${prod.price}`;

        const badgesEl = document.createElement('div');
        badgesEl.className = 'badges';
        const catBadge = document.createElement('span');
        catBadge.className = 'badge bg-primary me-2';
        catBadge.textContent = prod.category || 'N/A';

        const levelBadge = document.createElement('span');
        levelBadge.className = 'badge bg-info';
        levelBadge.textContent = prod.level || 'N/A';

        if (prod.indoorOutdoor) {
            const ioBadge = document.createElement('span');
            ioBadge.className = 'badge bg-secondary';
            ioBadge.textContent = prod.indoorOutdoor;
            badgesEl.appendChild(ioBadge);
            }

        badgesEl.appendChild(catBadge);
        badgesEl.appendChild(levelBadge);

        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-sm btn-success btn-add';
        addBtn.textContent = 'Add';
        if (prod.soldOut) {
          addBtn.disabled = true;
          nameEl.innerHTML = `<s>${prod.program}</s> (Sold Out)`;
        }
        addBtn.addEventListener('click', () => {
          addProductToCart(prod);
          cardDiv.classList.add('added');
          updateProgramCardState(cardDiv, prod);
        });

        const addedControls = document.createElement('div');
        addedControls.className = 'added-controls';
        addedControls.innerHTML = `
          <span class="text-success"><strong>&check;</strong> Added</span>
          <button class="btn btn-sm btn-outline-danger ms-2">Remove</button>
        `;
        const removeBtn = addedControls.querySelector('button');
        removeBtn.addEventListener('click', () => {
          removeProductFromCart(prod);
          cardDiv.classList.remove('added');
          updateProgramCardState(cardDiv, prod);
        });

        cardDiv.appendChild(nameEl);
        cardDiv.appendChild(priceEl);
        cardDiv.appendChild(badgesEl);
        cardDiv.appendChild(addBtn);
        cardDiv.appendChild(addedControls);

        container.appendChild(cardDiv);
      });
    }

    function updateProgramCardState(cardDiv, prod) {
      const inCart = cartItems.find(ci => ci.program === prod.program && ci.sessionId === selectedSession.spreadsheetId);
      if (inCart) {
        cardDiv.classList.add('added');
      } else {
        cardDiv.classList.remove('added');
      }
    }

    /************************************************************
     * 9) CART LOGIC
     ************************************************************/
    function addProductToCart(product) {
      if (!selectedSession) return;
      const sessionId = selectedSession.spreadsheetId;
      const existing = cartItems.find(ci => ci.program === product.program && ci.sessionId === sessionId);
      if (existing) return;

      cartItems.push({
        sessionId,
        program: product.program,
        price: product.price,
        sessionLabel: `${selectedSession.location} - ${selectedSession.season} (${selectedSession.date})`
      });
      updateCartTable();
    }

    function removeProductFromCart(product) {
      if (!selectedSession) return;
      const sessionId = selectedSession.spreadsheetId;
      const idx = cartItems.findIndex(ci => ci.program === product.program && ci.sessionId === sessionId);
      if (idx > -1) {
        cartItems.splice(idx, 1);
      }
      updateCartTable();
    }

    function updateCartTable() {
      const tbody = document.querySelector('#cart-table tbody');
      const cartSection = document.getElementById('cart-section');
      const amountDueLine = document.getElementById('amount-due-line');
      const breakdownLine = document.getElementById('breakdown-line');

      if (!tbody || !cartSection || !amountDueLine || !breakdownLine) return;

      tbody.innerHTML = '';
      if (cartItems.length === 0) {
        cartSection.style.display = 'none';
        amountDueLine.textContent = '';
        breakdownLine.textContent = '';
        updateCartSummaryPill();

        // CHANGED: If we're in list view, re-render the 7-day list. Otherwise, re-render the program cards.
        if (isListView) {
          renderProgramListForRange();
        } else {
          renderProgramCards();
        }
        return;
      }
      cartSection.style.display = 'block';

      cartItems.forEach((item, idx) => {
        const tr = document.createElement('tr');
        let tdProg = document.createElement('td');
        tdProg.textContent = item.program;
        tr.appendChild(tdProg);

        let tdSession = document.createElement('td');
        tdSession.textContent = item.sessionLabel;
        tr.appendChild(tdSession);

        let tdRemove = document.createElement('td');
        let btnRemove = document.createElement('button');
        btnRemove.className = 'btn btn-sm btn-danger';
        btnRemove.textContent = 'Remove';
        btnRemove.onclick = () => {
          cartItems.splice(idx, 1);
          updateCartTable();
        };
        tdRemove.appendChild(btnRemove);
        tr.appendChild(tdRemove);

        tbody.appendChild(tr);
      });

      // Compute raw total
      const totalCents = calculateCartTotalCents();
      const programTotal = totalCents / 100;

      // Subtract credit
      const credit = currentPlayer?.credit || 0;
      let creditUsed = (credit >= programTotal) ? programTotal : credit;
      let amountDue  = programTotal - creditUsed;

      amountDueLine.textContent = `Amount Due: $${amountDue.toFixed(2)}`;
      breakdownLine.textContent = `Program Total: $${programTotal.toFixed(2)} | Credit Balance: $${credit.toFixed(2)}`;

      updateCartSummaryPill();

      // CHANGED: If we're in list view, refresh the list; otherwise, refresh cards.
      if (isListView) {
        renderProgramListForRange();
      } else {
        renderProgramCards();
      }
    }

    function updateCartSummaryPill() {
      const pill = document.getElementById('cart-summary-pill');
      const totalCents = calculateCartTotalCents();
      const total = (totalCents / 100).toFixed(2);

      if (cartItems.length === 0) {
        pill.style.display = 'none';
        return;
      }
      pill.style.display = 'block';
      pill.textContent = `🛒 ${cartItems.length} item(s) - $${total}`;
    }

    function calculateCartTotalCents() {
      let total = 0;
      cartItems.forEach(item => {
        total += (item.price || 0);
      });
      return total * 100;
    }

    async function chargeCart(email, amountInCents) {
      showMessage(`Charging cart: Email=${email}, Amount=${amountInCents} cents`, 'debug');
      if (amountInCents <= 0) {
        return true; 
      }
      try {
        const payload = { email, amount: amountInCents };
        const resp = await fetch(CHARGE_CART_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.success) {
          showMessage('Payment succeeded in chargeCart.', 'info');
          return true;
        } else {
          showMessage('Payment failed: ' + (data.error || ''), 'error');
          return false;
        }
      } catch (err) {
        showMessage('Network error charging cart: ' + err.message, 'error');
        return false;
      }
    }

    /************************************************************
     * Payment Buttons
     ************************************************************/
    document.getElementById('btn-charge-on-file').addEventListener('click', async () => {
      if (cartItems.length === 0) {
        showMessage('Cart is empty.', 'error');
        return;
      }
      showPaymentSuccess(false);
      showPaymentSpinner(true);

      const totalCents = calculateCartTotalCents();
      const programTotal = totalCents / 100;
      const credit = currentPlayer?.credit || 0;
      let creditUsed = (credit >= programTotal) ? programTotal : credit;
      let amountDue  = programTotal - creditUsed;
      let amountDueCents = Math.round(amountDue * 100);

      const email = currentPlayer.email;
      const success = await chargeCart(email, amountDueCents);
      if (!success) {
        showMessage('Payment failed, not registering.', 'error');
        showPaymentSpinner(false);
        return;
      }

      // register
      showMessage('Payment succeeded (or $0 due), now registering items...', 'info');
      await submitCartToSpreadsheet(creditUsed);
      showMessage('Successfully registered after payment!', 'success');
      cartItems = [];
      updateCartTable();
      showPaymentSpinner(false);
      showPaymentSuccess(true);

      const leftoverCredit = Math.max(0, (currentPlayer?.credit || 0) - creditUsed);
      if (creditUsed > 0) {
        const paySuccessBox = document.getElementById('payment-success');
        if (paySuccessBox) {
          paySuccessBox.innerHTML = `
            Payment processed successfully! Your registration has been submitted.<br/>
            You have $${leftoverCredit.toFixed(2)} credit left.
          `;
        }
      }
    });

    document.getElementById('btn-credit-debit').addEventListener('click', () => {
      if (cartItems.length === 0) {
        alert('Cart is empty.');
        return;
      }
      const modalEl = new bootstrap.Modal(document.getElementById('oneTimePaymentModal'));
      modalEl.show();
    });

    document.getElementById('one-time-payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('otpf-card-errors').textContent = '';

      const nameOnCard = document.getElementById('otpf-name').value.trim();
      if (!nameOnCard) {
        document.getElementById('otpf-card-errors').textContent = 'Name is required.';
        return;
      }

      // Create PaymentMethod
      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: 'card',
        card: oneTimeCard,
        billing_details: {
          name: nameOnCard,
          email: currentPlayer?.email || ''
        }
      });
      if (error) {
        document.getElementById('otpf-card-errors').textContent = error.message;
        return;
      }
      showPaymentSpinner(true);

      const totalCents   = calculateCartTotalCents();
      const programTotal = totalCents / 100;
      const credit       = currentPlayer?.credit || 0;
      let creditUsed     = (credit >= programTotal) ? programTotal : credit; 
      let amountDue      = programTotal - creditUsed;
      let amountDueCents = Math.round(amountDue * 100);

      if (amountDueCents <= 0) {
        await registerAndCleanup(creditUsed);
        return;
      }

      // Call one-time function
      const payload = {
        amount: amountDueCents,
        paymentMethodId: paymentMethod.id
      };
      let clientSecret;
      try {
        const resp = await fetch('https://merry-rugelach-c028d1.netlify.app/.netlify/functions/chargeOneTime', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!data.success) {
          throw new Error(data.error || 'Failed to create PaymentIntent.');
        }
        clientSecret = data.clientSecret;
      } catch (err) {
        showPaymentSpinner(false);
        document.getElementById('otpf-card-errors').textContent = err.message;
        return;
      }

      try {
        const confirmResult = await stripe.confirmCardPayment(clientSecret);
        if (confirmResult.error) {
          showPaymentSpinner(false);
          document.getElementById('otpf-card-errors').textContent = confirmResult.error.message;
          return;
        }
        if (confirmResult.paymentIntent && confirmResult.paymentIntent.status === 'succeeded') {
          await registerAndCleanup(creditUsed);
        } else {
          showPaymentSpinner(false);
          document.getElementById('otpf-card-errors').textContent = 'Payment not completed.';
        }
      } catch (err) {
        showPaymentSpinner(false);
        document.getElementById('otpf-card-errors').textContent = err.message;
      }
    });

    async function registerAndCleanup(creditUsed) {
      await submitCartToSpreadsheet(creditUsed);
      cartItems = [];
      updateCartTable();
      showPaymentSpinner(false);
      showPaymentSuccess(true);
      const modalEl = bootstrap.Modal.getInstance(document.getElementById('oneTimePaymentModal'));
      modalEl.hide();
    }

    async function submitCartToSpreadsheet(creditUsed) {
      const payload = {
        action: 'registerMultiple',
        firstName: currentPlayer.firstName,
        lastName: currentPlayer.lastName,
        email: currentPlayer.email,
        phoneNumber: currentPlayer.phoneNumber,
        cartItems: cartItems.map(ci => ({
          sessionId: ci.sessionId,
          program: ci.program
        })),
        creditUsed: creditUsed || 0
      };

      try {
        const resp = await fetch(GAS_PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        showMessage(`registerMultiple response: ${JSON.stringify(data)}`, 'debug');
        if (!data.success) {
          showMessage('Error registering: ' + (data.error || ''), 'error');
        } else {
          // Update local credit
          currentPlayer.credit = Math.max(0, (currentPlayer.credit || 0) - creditUsed);
          updateCreditDisplay();
        }
      } catch (err) {
        showMessage('submitCartToSpreadsheet error: ' + err.message, 'error');
      }
    }

/************************************************************
 * 10) MY REGISTRATIONS
 ************************************************************/

// 1. Listen for the "My Registrations" tab to be shown, then load the data.
document.querySelector('a[data-bs-target="#tab-registrations"]')
  .addEventListener('shown.bs.tab', loadUserRegistrations);

async function loadUserRegistrations() {
  if (!currentPlayer || !currentPlayer.email) {
    showMessage('No user data found for registrations.', 'error');
    return;
  }
  showMessage('Loading user registrations from getUserRegistrations', 'debug');
  showRegistrationsSpinner(true);

  const url = `${GAS_PROXY}?action=getUserRegistrations&email=${encodeURIComponent(currentPlayer.email)}`;
  try {
    const resp = await fetch(url);
    const data = await resp.json();
    showMessage(`getUserRegistrations response: ${JSON.stringify(data)}`, 'debug');

    if (!data.success) {
      showMessage('Error loading registrations: ' + (data.error || ''), 'error');
      return;
    }

    // Instead of renderFullCalendar, we call our new list-based rendering:
    renderRegistrationsList(data.upcoming || []);

  } catch (err) {
    showMessage('Load registrations error: ' + err.message, 'error');
  } finally {
    showRegistrationsSpinner(false);
  }
}

/**
 * Renders registrations as a date-grouped list, rather than a calendar.
 * We still rely on parseProgramString() and its helpers for date/time parsing.
 */
function renderRegistrationsList(sessionsArray) {
  const container = document.getElementById('registrations-content');
  container.innerHTML = '';

  // Collect all "event" objects from your parseProgramString function
  const events = [];
  sessionsArray.forEach(sessionObj => {
    sessionObj.programs.forEach(programStr => {
      // parseProgramString returns an array of objects like:
      // [ { title: '...', start: ISOString, end: ISOString }, ... ]
      const parsedList = parseProgramString(programStr, sessionObj);
      if (Array.isArray(parsedList)) {
        parsedList.forEach(ev => {
          // Convert ISO timestamps to Date objects for easier sorting
          const startDate = new Date(ev.start);
          const endDate   = new Date(ev.end);
          events.push({
            title: ev.title,
            startDate,
            endDate
          });
        });
      }
    });
  });

  if (!events.length) {
    container.innerHTML = '<p>No upcoming registrations found.</p>';
    return;
  }

  // Sort events by start date/time ascending
  events.sort((a, b) => a.startDate - b.startDate);

  // Group by date (YYYY-MM-DD)
  const grouped = {};
  events.forEach(ev => {
    const dateKey = ev.startDate.toISOString().split('T')[0]; 
    if (!grouped[dateKey]) grouped[dateKey] = [];
    grouped[dateKey].push(ev);
  });

  // For each dateKey, render a heading and list the events
  Object.keys(grouped).sort().forEach(dateKey => {
    const dateObj = new Date(dateKey);
    const dateHeading = document.createElement('h5');
    dateHeading.className = 'py-2 px-3 text-white bg-primary mb-2 rounded';
    dateHeading.textContent = dateObj.toLocaleDateString(undefined, {
      weekday: 'long', month: 'short', day: 'numeric'
    });
    container.appendChild(dateHeading);

    grouped[dateKey].forEach(ev => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'mb-2 p-2 border rounded';

      // Event title
      const titleEl = document.createElement('div');
      titleEl.textContent = ev.title;
      itemDiv.appendChild(titleEl);

      // Time range, e.g. "1:00 PM - 2:00 PM"
      const timeEl = document.createElement('div');
      timeEl.className = 'small text-muted';
      const startTimeStr = ev.startDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      const endTimeStr   = ev.endDate.toLocaleTimeString([],   { hour: 'numeric', minute: '2-digit' });
      timeEl.textContent = `${startTimeStr} - ${endTimeStr}`;
      itemDiv.appendChild(timeEl);

      container.appendChild(itemDiv);
    });
  });
}

/**
 * parseProgramString(programStr, sessionObj)
 * (Unchanged from your existing code, except we've removed references to FullCalendar.)
 */
function parseProgramString(programStr, sessionObj) {
  const fallbackYear = new Date().getFullYear();

  if (programStr.includes(';')) {
    // e.g. (12/2 - 1/6; 1:00pm - 2:00pm)
    const dayMatch = programStr.match(/\b(Monday|Mondays|Tuesday|Tuesdays|Wednesday|Wednesdays|Thursday|Thursdays|Friday|Fridays|Saturday|Saturdays|Sunday|Sundays)\b/i);
    let dayName = 'Monday';
    if (dayMatch) {
      dayName = dayMatch[1];
    }
    const dayOfWeek = mapDayNameToNumber(dayName);

    const parenMatch = programStr.match(/\(([^)]+)\)/);
    if (!parenMatch) return [];
    const inside = parenMatch[1].trim(); 
    const [datesPart, timesPart] = inside.split(';').map(s => s.trim());
    const [startDateStr, endDateStr] = datesPart.split('-').map(s => s.trim());
    const startDate = parseMMDD(startDateStr, fallbackYear);
    const endDate   = parseMMDD(endDateStr, fallbackYear);

    const [startTimeStr, endTimeStr] = timesPart.split('-').map(s => s.trim());
    const startTime = parseTime(startTimeStr);
    const endTime   = parseTime(endTimeStr);

    return createWeeklyEventsInRange({
      title: formatEventTitleWithCategory(programStr),
      dayOfWeek,
      startDate,
      endDate,
      startTime,
      endTime
    });

  } else {
    // e.g. "Monday 1/6 | 1:00pm - 2:00pm (2.0 - 3.0)"
    const match = programStr.match(/(\d{1,2}\/\d{1,2})\s*\|\s*([\d:apm\s]+-\s*[\d:apm\s]+)/);
    if (!match) return [];
    const dateStr   = match[1];
    const timesStr  = match[2];
    const singleDate = parseMMDD(dateStr, fallbackYear);
    const [startTimeStr, endTimeStr] = timesStr.split('-').map(s => s.trim());
    const startTime = parseTime(startTimeStr);
    const endTime   = parseTime(endTimeStr);

    const startDateTime = combineDateTime(singleDate, startTime);
    const endDateTime   = combineDateTime(singleDate, endTime);

    return [{
      title: formatEventTitleWithCategory(programStr),
      start: startDateTime.toISOString(),
      end: endDateTime.toISOString()
    }];
  }
}

/**
 * formatEventTitleWithCategory(rawString)
 * (Same logic you had before to embed category/level in the event title.)
 */
function formatEventTitleWithCategory(rawString) {
  const matchParen = rawString.match(/\s*\(([^)]+)\)$/);
  if (!matchParen) {
    return rawString;
  }
  const locationName = matchParen[1].trim();  
  const trimmedProgram = rawString.replace(/\s*\([^)]*\)$/, '');
  const sessionObj = allSessions.find(s => {
    return s.location && s.location.includes(locationName);
  });
  if (!sessionObj) {
    return rawString;
  }
  const product = sessionObj.products.find(p => p.program === trimmedProgram);
  if (!product) {
    return rawString;
  }
  const cat = product.category || 'Unknown Category';
  const lvl = product.level || 'Unknown Level';
  return `${cat} ${lvl} (${locationName})`;
}

/**
 * mapDayNameToNumber(dayName)
 */
function mapDayNameToNumber(dayName) {
  const dn = dayName.toLowerCase();
  if (dn.startsWith('sun')) return 0;
  if (dn.startsWith('mon')) return 1;
  if (dn.startsWith('tue')) return 2;
  if (dn.startsWith('wed')) return 3;
  if (dn.startsWith('thu')) return 4;
  if (dn.startsWith('fri')) return 5;
  if (dn.startsWith('sat')) return 6;
  return 1;
}

/**
 * createWeeklyEventsInRange({ title, dayOfWeek, startDate, endDate, startTime, endTime })
 */
function createWeeklyEventsInRange({ title, dayOfWeek, startDate, endDate, startTime, endTime }) {
  const events = [];
  const current = new Date(startDate);
  while (current <= endDate) {
    if (current.getDay() === dayOfWeek) {
      const startDateTime = combineDateTime(current, startTime);
      const endDateTime   = combineDateTime(current, endTime);
      events.push({
        title,
        start: startDateTime.toISOString(),
        end:   endDateTime.toISOString()
      });
    }
    current.setDate(current.getDate() + 1);
  }
  return events;
}

/**
 * parseMMDD(mmdd, year)
 */
function parseMMDD(mmdd, year) {
  const [m, d] = mmdd.split('/').map(Number);
  return new Date(year, m - 1, d);
}

/**
 * parseTime(timestr)
 */
function parseTime(timestr) {
  timestr = timestr.toLowerCase().replace(/\s+/g, '');
  const ampm = timestr.endsWith('am') ? 'am' : 'pm';
  timestr = timestr.replace(/am|pm/, '');

  const [hh, mm] = timestr.split(':').map(Number);
  let hour = hh;
  let minute = mm || 0;

  if (ampm === 'pm' && hour < 12) hour += 12;
  if (ampm === 'am' && hour === 12) hour = 0;

  return { hour, minute };
}

/**
 * combineDateTime(dateObj, timeObj)
 */
function combineDateTime(dateObj, timeObj) {
  return new Date(
    dateObj.getFullYear(),
    dateObj.getMonth(),
    dateObj.getDate(),
    timeObj.hour,
    timeObj.minute,
    0
  );
}


    /************************************************************
     * 11) PROFILE & LOGOUT
     ************************************************************/
    function setProfileData(player) {
      document.getElementById('profile-first-name').textContent = player.firstName || '';
      document.getElementById('profile-last-name').textContent = player.lastName || '';
      document.getElementById('profile-phone').textContent = player.phoneNumber || '';
      document.getElementById('profile-email').textContent = player.email || '';

      const cardSpan   = document.getElementById('profile-card-last4');
      const cardButton = document.getElementById('profile-card-button');

      if (player.cardLast4) {
        cardSpan.textContent = `**** **** **** ${player.cardLast4}`;
        cardButton.style.display = 'inline-block';
        cardButton.textContent   = 'Update Card';
        cardButton.onclick = () => {
          window.open('https://billing.stripe.com/p/login/9AQ9Dc83k8pg6QM7ss', '_blank');
        };
      } else {
        cardSpan.textContent = 'No card on file';
        cardButton.style.display = 'inline-block';
        cardButton.textContent   = 'Add Card';
        cardButton.onclick = () => {
          const modalEl = new bootstrap.Modal(document.getElementById('paymentModal'));
          modalEl.show();
        };
      }

      updateCreditDisplay();
    }

    function updateCreditDisplay() {
      const creditSpan = document.getElementById('profile-credit-amount');
      if (!creditSpan) return;
      const creditVal = currentPlayer?.credit || 0;
      if (creditVal > 0) {
        creditSpan.textContent = `$${creditVal.toFixed(2)}`;
      } else {
        creditSpan.textContent = 'No credit available';
      }
    }

    document.getElementById('logout-button').addEventListener('click', () => {
      showMessage('Logout clicked, clearing localStorage.', 'debug');
      localStorage.removeItem('playerEmail');
      currentPlayer = null;
      cartItems = [];
      allProducts = [];
      document.getElementById('tab-content-section').style.display = 'none';
      document.getElementById('verification-section').style.display = 'block';
      showMessage('Logged out.', 'info');
    });

    /************************************************************
     * 12) UTILITY: showMessage
     ************************************************************/
    function showMessage(msg, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${msg}`);
      // Optionally display a toast or alert in the UI
    }

    /************************************************************
     * TOGGLE CALENDAR VIEW & 7-DAY LIST
     ************************************************************/
    function showToggleCalendarButton(shouldShow) {
      const toggleViewContainer = document.getElementById('toggle-view-container');
      if (!toggleViewContainer) return;
      toggleViewContainer.style.display = shouldShow ? 'block' : 'none';
    }

    document.getElementById('standardized-level-filter').addEventListener('change', () => {
  selectedStandardizedLevel = document.getElementById('standardized-level-filter').value.trim();
  // Refresh whichever view is relevant:
  if (isListView) {
    renderProgramListForRange();
  } else {
    renderProgramCards();
  }
});

    // Toggle button => flips isListView, calls updateRegisterViewMode()
    document.getElementById('btn-toggle-calendar-view').addEventListener('click', () => {
      isListView = !isListView;
      updateRegisterViewMode();
      const programCardsContainer = document.getElementById('program-cards-container');
    });

    function populateStandardizedLevelDropdown() {
  const sLevelSelect = document.getElementById('standardized-level-filter');
  sLevelSelect.innerHTML = '<option value="">--All Standardized Levels--</option>';

  const sLevelsSet = new Set();  
  allProducts.forEach(prod => {
    (prod.standardizedLevelList || []).forEach(lvl => {
      sLevelsSet.add(lvl);
    });
  });

  const sLevelsArray = Array.from(sLevelsSet).sort();  // convert to array, optionally sort
  sLevelsArray.forEach(sl => {
    const opt = document.createElement('option');
    opt.value = sl;
    opt.textContent = sl;
    sLevelSelect.appendChild(opt);
  });

  document.getElementById('standardized-level-filter-group').style.display = 'block';
}



    // Show/hide filters or list
    function updateRegisterViewMode() {
  const filterSection         = document.getElementById('filter-section');
  const programCardsContainer = document.getElementById('program-cards-container');
  const listViewContainer     = document.getElementById('list-view-container');
  const listContent           = document.getElementById('program-list-content');

  // If we are switching *to* list view
  if (isListView) {
    // 1) Hide all filter UI and program cards
    showFilterStep(0); // sets everything to display: none
    programCardsContainer.style.display = 'none';

    // 2) Show the 7-day list container
    listViewContainer.style.display = 'block';

    // 3) If a session is selected, render that 7-day list
    if (selectedSession) {
      renderProgramListForRange();
    } else {
      // If no session is selected yet, give a prompt
      listContent.innerHTML = '<p>Please select a session above.</p>';
    }

  // Otherwise, we're switching *back* to the "filters/cards" view
  } else {
    // 1) Hide the 7-day list
    listViewContainer.style.display = 'none';

    // 2) If a session is selected, show the correct filter step
    if (selectedSession) {
      // If user has *already* chosen day/time, we might go straight to step 4
      // Otherwise, we show step 1 (or 2/3 if partial filters are filled in).
      if (selectedDayTime) {
        showFilterStep(4); // reveals the program cards
      } else {
        showFilterStep(1); // or 2/3, depending on your filter logic
      }
    } else {
      // If no session is selected, just leave everything hidden (step 0)
      showFilterStep(0);
    }
  }

  // Finally, if we *remain* in list view, re-hide program cards in case
  // something else called showFilterStep(4) behind the scenes:
  if (isListView) {
    programCardsContainer.style.display = 'none';
  }
}



    // Prepare earliest & latest date for the session
    function prepareListViewDates(sessionObj) {
      const validDates = [];
      const today = startOfDay(new Date());
      (sessionObj.products || []).forEach(prod => {
        if (!prod.program || prod.program.toLowerCase().includes('package')) return;
        const dt = parseProgramDate(prod.program);
        if (dt) validDates.push(dt);
      });
      if (!validDates.length) {
        minProgramDate = today;
        maxProgramDate = today;
        listViewStartDate = today;
        return;
      }
      validDates.sort((a, b) => a - b);
      minProgramDate = startOfDay(validDates[0]);
      maxProgramDate = startOfDay(validDates[validDates.length - 1]);
      listViewStartDate = (minProgramDate < today) ? today : minProgramDate;
    }

    function startOfDay(d) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function parseProgramDate(programStr) {
      if (!programStr.includes('|')) return null;
      const leftSide = programStr.split('|')[0].trim();
      const parts = leftSide.split(' ');
      if (parts.length < 2) return null;
      const mmdd = parts[parts.length - 1];
      const [mm, dd] = mmdd.split('/').map(Number);
      if (!mm || !dd) return null;

      const now = new Date();
      let yyyy = now.getFullYear();
      const dateObj = new Date(yyyy, mm - 1, dd);

      // If it's more than ~6 months in the past, assume next year
      if (dateObj.getTime() < now.getTime() - 15778476000) {
        dateObj.setFullYear(yyyy + 1);
      }
      return startOfDay(dateObj);
    }

    // Render the 7-day list
    function renderProgramListForRange() {
  const container = document.getElementById('program-list-content');
  if (!container || !selectedSession || !listViewStartDate) return;
  container.innerHTML = '';

  const rangeStart = startOfDay(listViewStartDate);
  const rangeEnd   = new Date(rangeStart);
  rangeEnd.setDate(rangeEnd.getDate() + 6);

  // Format the dates however you like:
    const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
    const startStr = rangeStart.toLocaleDateString(undefined, options);
    const endStr   = rangeEnd.toLocaleDateString(undefined, options);

    // Build a heading or paragraph
    const rangeLabel = document.createElement('div');
    rangeLabel.className = 'fs-3 mb-2 d-flex justify-content-center align-items-center';  // example classes for styling
    rangeLabel.textContent = `${startStr} – ${endStr}`;

    // Insert it into the container at the top
    container.appendChild(rangeLabel);

  // Filter out invalid or "package" items, and only keep those within [rangeStart, rangeEnd].
  let filtered = (selectedSession.products || []).filter(prod => {
    if (!prod.program) return false;
    if (prod.program.toLowerCase().includes('package')) return false;
    const dt = parseProgramDate(prod.program);
    if (!dt) return false;
    return dt >= rangeStart && dt <= rangeEnd;
  });

    //If the user has chosen a Standardized Level, filter on that too
    if (selectedStandardizedLevel) {
  filtered = filtered.filter(p => 
    p.standardizedLevelList.includes(selectedStandardizedLevel)
  );
}

  // Sort by date ascending.
  filtered.sort((a, b) => {
    const dA = parseProgramDate(a.program);
    const dB = parseProgramDate(b.program);
    return dA - dB;
  });

  // Group by date (YYYY-MM-DD).
  const groups = {};
  filtered.forEach(prod => {
    const dt = parseProgramDate(prod.program);
    const dateKey = dt.toISOString().substr(0, 10);
    if (!groups[dateKey]) groups[dateKey] = [];
    groups[dateKey].push(prod);
  });

  if (!Object.keys(groups).length) {
    container.innerHTML = `<p>No programs found in this 7-day window.</p>`;
    return;
  }

  Object.keys(groups).sort().forEach(dateKey => {
    const dt = new Date(`${dateKey}T00:00:00`);

    // Date header
    const dateHeader = document.createElement('h5');
    dateHeader.className = 'py-2 px-3 text-white bg-primary mb-2 rounded';
    dateHeader.textContent = dt.toLocaleDateString(undefined, {
      weekday: 'long', month: 'short', day: 'numeric'
    });
    container.appendChild(dateHeader);

    // For each program in this date group
    groups[dateKey].forEach(prod => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'calendar-list-item mb-2 p-2 border rounded position-relative';

      // Check if already in cart
      const inCart = cartItems.find(ci => 
        ci.program === prod.program && 
        ci.sessionId === selectedSession.spreadsheetId
      );
      if (inCart) {
        itemDiv.classList.add('added');
      }

      // Build a display-only label. Do NOT overwrite `prod.program`!
      const categoryLevel = `${prod.category || 'N/A'}`;
      const displayText = `${prod.category}: ${prod.program}`;

      // Main label
      const labelEl = document.createElement('div');
      labelEl.textContent = displayText;
      if (prod.soldOut) {
        labelEl.innerHTML = `<s>${displayText}</s> (Sold Out)`;
      }
      itemDiv.appendChild(labelEl);

      // Price (if any)
      if (prod.price) {
        const priceEl = document.createElement('div');
        priceEl.className = 'small text-muted';
        priceEl.textContent = `Price: $${prod.price}`;
        itemDiv.appendChild(priceEl);
      }

      if (prod.program) {
        const prgmBadge = document.createElement('span');
        prgmBadge.className = 'badge bg-primary me-2 mt-2';
        prgmBadge.textContent = prod.level;
        itemDiv.appendChild(prgmBadge);
        }

      if (prod.indoorOutdoor) {
        const ioBadge = document.createElement('span');
        ioBadge.className = 'badge bg-secondary me-2 mt-2';
        ioBadge.textContent = prod.indoorOutdoor;
        itemDiv.appendChild(ioBadge);
        itemDiv.appendChild(document.createElement('br'));
        }

      // Add/Remove UI
      const addBtn = document.createElement('button');
      addBtn.className = 'btn btn-sm btn-success btn-add me-2 mt-2';
      addBtn.textContent = 'Add';
      if (prod.soldOut) addBtn.disabled = true;

      const addedControls = document.createElement('div');
      addedControls.className = 'added-controls mt-2';
      addedControls.innerHTML = `
        <span class="text-success"><strong>&check;</strong> Added</span>
        <button class="btn btn-sm btn-outline-danger ms-2">Remove</button>
      `;
      const removeBtn = addedControls.querySelector('button');

      // ***********************************
      // MAIN CHANGE: Show/hide based on inCart
      // ***********************************
      if (inCart) {
        addBtn.style.display = 'none';
        addedControls.style.display = 'block';
      } else {
        addBtn.style.display = 'inline-block';
        addedControls.style.display = 'none';
      }

      // Click => Add
      addBtn.addEventListener('click', () => {
        addProductToCart(prod);
        itemDiv.classList.add('added');
        addBtn.style.display = 'none';
        addedControls.style.display = 'block';
      });

      // Click => Remove
      removeBtn.addEventListener('click', () => {
        removeProductFromCart(prod);
        itemDiv.classList.remove('added');
        addBtn.style.display = 'inline-block';
        addedControls.style.display = 'none';
      });

      itemDiv.appendChild(addBtn);
      itemDiv.appendChild(addedControls);
      container.appendChild(itemDiv);
    });
  });
}
    // Prev/Next 7-day window
    document.getElementById('btn-list-prev').addEventListener('click', () => {
      if (!listViewStartDate || !minProgramDate) return;
      const newStart = new Date(listViewStartDate);
      newStart.setDate(newStart.getDate() - 7);
      if (newStart < minProgramDate) {
        newStart.setTime(minProgramDate.getTime());
      }
      listViewStartDate = newStart;
      renderProgramListForRange();
    });

    document.getElementById('btn-list-next').addEventListener('click', () => {
      if (!listViewStartDate || !maxProgramDate) return;
      const newStart = new Date(listViewStartDate);
      newStart.setDate(newStart.getDate() + 7);
      if (newStart > maxProgramDate) {
        newStart.setTime(maxProgramDate.getTime());
      }
      listViewStartDate = newStart;
      renderProgramListForRange();
    });
</script>
</body>
</html>
