<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Registration with Email Verification & Payment</title>
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <link rel="manifest" href="manifest.json">

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <link rel="icon" href="icons/icon-192x192.png">

  <!-- Service Worker Registration -->
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => console.log('Service Worker registered:', registration))
      .catch(error => console.error('Service Worker registration failed:', error));
  }
  </script>

  <!-- IMPORTANT: Use viewport-fit=cover for iPhone safe-area -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <style>
    /* 1) Remove default margin on body and add padding for iPhone safe-area */
    body {
      margin: 0;
      padding-bottom: calc(80px + env(safe-area-inset-bottom));
      background-color: #f9f9f9;
    }

    /* 2) Fixed bottom nav with safe-area padding. Also highlight the active link with a background color. */
    .nav-bottom {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding-bottom: env(safe-area-inset-bottom);
      background-color: #fff;
      border-top: 1px solid #ddd;
      z-index: 999;
      display: flex;
    }
    .nav-bottom .nav-link {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      color: #000;
    }
    .nav-bottom .nav-link.active {
      background-color: #0d6efd; /* Bootstrap primary color */
      color: #fff;              /* White text for contrast */
      font-weight: 500;
    }

    .tab-content {
      padding: 1rem;
    }

    /* Hide main tab content until user is verified */
    #tab-content-section {
      display: none;
    }

    /* Email verification UI */
    #verification-section {
      display: none; 
      max-width: 500px;
      margin: 30px auto;
      padding: 20px;
      background: #fff;
      border-radius: 5px;
    }
    .card-errors {
      color: red;
    }

    /* Profile container with a spinner overlay */
    #profile-container {
      position: relative; 
    }
    #profile-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      display: none; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #profile-content {
      display: none; 
    }

    /* Register tab container with position: relative for overlays */
    #register-container {
      position: relative; 
    }

    /* 
      FULL OVERLAY for Session Loading:
      Covers everything except the Session dropdown. 
    */
    #session-spinner-overlay {
      display: none;
      position: absolute;
      top: 0; 
      left: 0; 
      width: 100%;
      height: 100%;
      z-index: 800; /* Below the session dropdown but above filters */
      background: rgba(255,255,255,0.9);
    }
    /* The spinner box itself (above the overlay) */
    #session-spinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 801; /* On top of the overlay */
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* Payment Spinner overlay while processing payment */
    #payment-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      display: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    #payment-success {
      display: none; 
      margin-top: 10px;
    }

    /* My Registrations container with a spinner overlay */
    #registrations-container {
      position: relative;
    }
    #registrations-spinner {
      display: none;
      position: absolute; 
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 999;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* 
      Hide the entire filters container (Category, Level, Day/Time, product table) 
      until we load the session data
    */
    #filters-container {
      display: none;
    }

    /* 
      Place the Session dropdown at a higher z-index than the overlay,
      so it remains visible when spinner shows.
    */
    #session-dropdown {
      position: relative;
      z-index: 900; /* Above the overlay at z-index: 800 */
    }
  </style>
</head>
<body class="bg-light">

  <!-- HEADER (Optional) -->
  <header class="bg-primary text-white p-3 mb-2">
    <h4 class="mb-0">Player Registration</h4>
  </header>

  <!-- EMAIL VERIFICATION SECTION (Only for first-time devices) -->
  <section id="verification-section" class="shadow-sm">
    <h5>Verify Your Email</h5>
    <p>Enter your email to receive a 6-digit code.</p>
    <form id="verification-form">
      <div class="mb-3">
        <label for="verify-email-input" class="form-label">Email Address</label>
        <input type="email" class="form-control" id="verify-email-input" required />
      </div>
      <button type="submit" class="btn btn-primary w-100 mb-2">
        Send Verification Code
      </button>
    </form>

    <div id="code-entry" style="display: none;">
      <p>Enter the 6-digit code we sent to your email:</p>
      <div class="mb-3">
        <input type="text" class="form-control" id="verify-code-input" placeholder="123456" />
      </div>
      <button id="verify-code-button" class="btn btn-secondary w-100">
        Verify Code
      </button>
    </div>
  </section>

  <!-- MAIN TAB CONTENT (Once verified) -->
  <section id="tab-content-section">
    <div class="tab-content" id="myTabContent">

      <!-- PROFILE TAB -->
      <div class="tab-pane fade show active" id="tab-profile" role="tabpanel">
        <div class="bg-white p-3 rounded shadow-sm" id="profile-container">
          
          <!-- Spinner Overlay (centered) -->
          <div id="profile-spinner">
            <div class="text-center">
              <div class="spinner-border text-primary mb-2" role="status"></div>
              <p class="mb-0">Logging you in!</p>
            </div>
          </div>

          <!-- Actual Profile Content -->
          <div id="profile-content">
            <h5>Profile</h5>
            <p><strong>First Name:</strong> <span id="profile-first-name"></span></p>
            <p><strong>Last Name:</strong> <span id="profile-last-name"></span></p>
            <p><strong>Phone:</strong> <span id="profile-phone"></span></p>
            <p><strong>Email:</strong> <span id="profile-email"></span></p>
            <p><strong>Card on File:</strong> <span id="profile-card-last4">No card on file</span></p>

            <button id="logout-button" class="btn btn-danger w-100 mt-3">Logout</button>
          </div>
        </div>
      </div>

      <!-- REGISTER TAB -->
      <div class="tab-pane fade" id="tab-register" role="tabpanel">
        <div class="bg-white p-3 rounded shadow-sm position-relative" id="register-container">
          
          <!-- FULL OVERLAY to cover everything but session dropdown -->
          <div id="session-spinner-overlay"></div>
          <!-- The spinner box itself -->
          <div id="session-spinner">
            <div class="text-center">
              <div class="spinner-border text-primary mb-2" role="status"></div>
              <p class="mb-0">Loading...</p>
            </div>
          </div>

          <!-- Payment Spinner overlay while processing payment -->
          <div id="payment-spinner">
            <div class="text-center">
              <div class="spinner-border text-primary mb-2" role="status"></div>
              <p class="mb-0">Processing Payment...</p>
            </div>
          </div>

          <!-- Payment success alert -->
          <div id="payment-success" class="alert alert-success" role="alert">
            Payment processed successfully! Your registration has been submitted.
          </div>

          <h5>Register for a Program</h5>

          <!-- Session Selection (always visible, above the overlay) -->
          <div class="mb-3">
            <label class="form-label">Select Session</label>
            <select id="session-dropdown" class="form-select">
              <option value="">--Select a Session--</option>
            </select>
          </div>

          <!-- FILTERS + PRODUCT/CART TABLES, hidden until session data is loaded -->
          <div id="filters-container">
            <!-- Category Filter -->
            <div class="mb-3">
              <label class="form-label">Select Category</label>
              <select id="category-filter" class="form-select">
                <option value="">--All Categories--</option>
              </select>
            </div>

            <!-- Level Filter -->
            <div class="mb-3">
              <label class="form-label">Select Level</label>
              <select id="level-filter" class="form-select">
                <option value="">--All Levels--</option>
              </select>
            </div>

            <!-- Day/Time Filter -->
            <div class="mb-3">
              <label class="form-label">Select Day/Time</label>
              <select id="daytime-filter" class="form-select">
                <option value="">--All Day/Times--</option>
              </select>
            </div>

            <!-- Display Filtered Products -->
            <table class="table table-striped table-sm" id="product-table">
              <thead>
                <tr>
                  <th>Program</th>
                  <th>Price</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <hr/>
            <h6>Your Selections</h6>
            <table class="table table-striped table-sm" id="cart-table">
              <thead>
                <tr>
                  <th>Program</th>
                  <th>Session</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button id="submit-cart-button" class="btn btn-primary w-100">
              Submit All
            </button>
          </div>
        </div>
      </div>

      <!-- MY REGISTRATIONS TAB -->
      <div class="tab-pane fade" id="tab-registrations" role="tabpanel">
        <!-- Container for the registrations content + spinner overlay -->
        <div class="bg-white p-3 rounded shadow-sm position-relative" id="registrations-container">
          
          <!-- Registrations Loading Spinner -->
          <div id="registrations-spinner">
            <div class="text-center">
              <div class="spinner-border text-primary mb-2" role="status"></div>
              <p class="mb-0">Loading Registrations...</p>
            </div>
          </div>

          <h5>My Registrations</h5>

          <h6>Current/Upcoming Seasons</h6>
          <div class="accordion" id="accordion-upcoming"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- FIXED BOTTOM NAV -->
  <nav class="nav nav-bottom d-flex justify-content-around">
    <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-profile" role="tab">
      <span class="d-block">Profile</span>
    </a>
    <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-register" role="tab">
      <span class="d-block">Register</span>
    </a>
    <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-registrations" role="tab">
      <span class="d-block">My Registrations</span>
    </a>
  </nav>

  <!-- PAYMENT MODAL -->
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Payment Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Please add a payment method to continue.</p>
          <form id="payment-form">
            <div class="mb-3">
              <label for="name-input" class="form-label">Name</label>
              <input type="text" class="form-control" id="name-input" required />
            </div>
            <div class="mb-3">
              <label for="card-element" class="form-label">Card</label>
              <div id="card-element" class="form-control"></div>
              <div id="card-errors" class="card-errors"></div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Payment Profile</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /************************************************************
     * 1) CONFIG & STRIPE SETUP
     ************************************************************/
    const GAS_PROXY = 'https://merry-rugelach-c028d1.netlify.app/.netlify/functions/proxy';
    const FIND_STRIPE_URL = 'https://merry-rugelach-c028d1.netlify.app/.netlify/functions/findStripe';
    const CREATE_STRIPE_URL = 'https://merry-rugelach-c028d1.netlify.app/.netlify/functions/createStripe';
    const CHARGE_CART_URL = 'https://merry-rugelach-c028d1.netlify.app/.netlify/functions/chargeCart';

    const stripe = Stripe('pk_live_51N9BzSHaWNal9rme3vwhLRs3vRgdqPQO35KZ2WQHPvefzbh2dP1VRCLTc8wKBNxN3jk8VXkeu8P3MJxnoJ1A3JaP00OotZGNnb');
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    let currentPlayer = null; 
    let allProducts = [];
    let cartItems = [];

    /************************************************************
     * 2) ON PAGE LOAD
     ************************************************************/
    window.addEventListener('DOMContentLoaded', () => {
      const storedEmail = localStorage.getItem('playerEmail');
      if (storedEmail) {
        showMessage(`LocalStorage email found: ${storedEmail}`, 'debug');
        document.getElementById('tab-content-section').style.display = 'block';
        initiateValidationFlow(storedEmail);
      } else {
        showMessage('No stored email found; showing verification UI.', 'debug');
        document.getElementById('verification-section').style.display = 'block';
      }
    });

    /************************************************************
     * 3) SPINNER LOGIC
     ************************************************************/
    function showProfileSpinner(shouldShow) {
      const spinner = document.getElementById('profile-spinner');
      const profileContent = document.getElementById('profile-content');
      if (!spinner || !profileContent) return;

      if (shouldShow) {
        spinner.style.display = 'block';
        profileContent.style.display = 'none';
      } else {
        spinner.style.display = 'none';
        profileContent.style.display = 'block';
      }
    }

    function showPaymentSpinner(shouldShow) {
      const spinner = document.getElementById('payment-spinner');
      const successBox = document.getElementById('payment-success');
      if (!spinner || !successBox) return;

      if (shouldShow) {
        spinner.style.display = 'block';
        successBox.style.display = 'none';
      } else {
        spinner.style.display = 'none';
      }
    }

    /* For the full overlay spinner */
    function showSessionSpinner(shouldShow) {
      const overlay = document.getElementById('session-spinner-overlay');
      const spinner = document.getElementById('session-spinner');
      if (!overlay || !spinner) return;

      if (shouldShow) {
        overlay.style.display = 'block';  // The semi-transparent background
        spinner.style.display = 'block';  // The spinner box
      } else {
        overlay.style.display = 'none';
        spinner.style.display = 'none';
      }
    }

    /* Spinner for Registrations */
    function showRegistrationsSpinner(shouldShow) {
      const spinner = document.getElementById('registrations-spinner');
      if (!spinner) return;
      spinner.style.display = shouldShow ? 'block' : 'none';
    }

    function showPaymentSuccess(shouldShow) {
      const successBox = document.getElementById('payment-success');
      if (!successBox) return;
      successBox.style.display = shouldShow ? 'block' : 'none';
    }

    /* Show/hide the container with category/level/day/time + product table */
    function showFiltersContainer(shouldShow) {
      const container = document.getElementById('filters-container');
      if (!container) return;
      container.style.display = shouldShow ? 'block' : 'none';
    }

    /************************************************************
     * 4) EMAIL VERIFICATION
     ************************************************************/
    document.getElementById('verification-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('verify-email-input').value.trim().toLowerCase();
      if (!emailInput) return;

      const url = `${GAS_PROXY}?action=sendVerificationEmail&email=${encodeURIComponent(emailInput)}`;
      try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (data.success) {
          window.__verificationCode = data.code;
          document.getElementById('code-entry').style.display = 'block';
          showMessage(`(Debug) Verification code is: ${data.code}`, 'debug');
        } else {
          alert('Error sending code: ' + (data.error || 'Unknown'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    });

    document.getElementById('verify-code-button').addEventListener('click', () => {
      const userCode = document.getElementById('verify-code-input').value.trim();
      const actualCode = window.__verificationCode;
      if (userCode === actualCode) {
        const verifiedEmail = document.getElementById('verify-email-input').value.trim().toLowerCase();
        localStorage.setItem('playerEmail', verifiedEmail);

        alert('Email verified!');
        document.getElementById('verification-section').style.display = 'none';
        document.getElementById('tab-content-section').style.display = 'block';
        initiateValidationFlow(verifiedEmail);
      } else {
        alert('Invalid code. Please check your email or resend.');
      }
    });

    /************************************************************
     * 5) INITIATE VALIDATION FLOW (Players + Stripe)
     ************************************************************/
    async function initiateValidationFlow(email) {
      showMessage(`initiateValidationFlow for email: ${email}`, 'debug');
      showProfileSpinner(true);

      try {
        // 1) getPlayerInfo
        const playerUrl = `${GAS_PROXY}?action=getPlayerInfo&email=${encodeURIComponent(email)}`;
        const playerResp = await fetch(playerUrl);
        const playerData = await playerResp.json();
        showMessage(`playerData: ${JSON.stringify(playerData)}`, 'debug');

        if (!playerData.success || !playerData.player) {
          showMessage(`Error retrieving or not a valid player: ${playerData.error}`, 'error');
          showProfileSpinner(false);
          return;
        }
        currentPlayer = playerData.player;
        setProfileData(currentPlayer);

        // 2) Check Stripe
        const stripeUrl = `${FIND_STRIPE_URL}?email=${encodeURIComponent(email)}`;
        const stripeResp = await fetch(stripeUrl);
        const stripeData = await stripeResp.json();
        showMessage(`stripeData: ${JSON.stringify(stripeData)}`, 'debug');

        if (!stripeData.success) {
          showMessage('Error checking Stripe: ' + (stripeData.error || ''), 'error');
          showProfileSpinner(false);
          return;
        }

        if (!stripeData.exists) {
          showMessage('No Stripe customer found -> show payment form', 'debug');
          showProfileSpinner(false);
          const modalEl = new bootstrap.Modal(document.getElementById('paymentModal'));
          modalEl.show();
        } else {
          showMessage('Stripe customer found', 'debug');
          currentPlayer.cardLast4 = stripeData.cardLast4 || null;
          setProfileData(currentPlayer);

          // 3) Load sessions with a session spinner
          showSessionSpinner(true);
          await loadSessions();
          showSessionSpinner(false);

          showProfileSpinner(false);
        }
      } catch (err) {
        showMessage('initiateValidationFlow error: ' + err.message, 'error');
        showProfileSpinner(false);
        showSessionSpinner(false);
      }
    }

    /************************************************************
     * 6) PAYMENT PROFILE FORM
     ************************************************************/
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nameInput = document.getElementById('name-input').value.trim();
      const email = currentPlayer?.email || '';

      showMessage(`Creating PaymentMethod for email: ${email}`, 'debug');
      const { paymentMethod, error } = await stripe.createPaymentMethod({
        type: 'card',
        card: cardElement,
        billing_details: { name: nameInput, email }
      });
      if (error) {
        showMessage('Stripe error: ' + error.message, 'error');
        return;
      }
      showMessage(`PaymentMethod created: ${paymentMethod.id}`, 'debug');

      const payload = { name: nameInput, email, paymentMethodId: paymentMethod.id };
      try {
        const resp = await fetch(CREATE_STRIPE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        showMessage(`createStripe response: ${JSON.stringify(data)}`, 'debug');

        if (!data.success) {
          showMessage('Error creating Stripe customer: ' + (data.error || ''), 'error');
          return;
        }
        showMessage('Payment profile created successfully!', 'success');

        // Hide modal
        const modalEl = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
        modalEl.hide();

        // Load sessions after creating the Stripe customer
        showSessionSpinner(true);
        await loadSessions();
        showSessionSpinner(false);
      } catch (err) {
        showMessage('Payment profile error: ' + err.message, 'error');
      }
    });

    /************************************************************
     * 7) LOAD SESSIONS
     ************************************************************/
    async function loadSessions() {
      showMessage('Loading sessions from getSessions', 'debug');
      try {
        const url = `${GAS_PROXY}?action=getSessions`;
        const resp = await fetch(url);
        const data = await resp.json();
        showMessage(`getSessions response: ${JSON.stringify(data)}`, 'debug');

        if (!data.success) {
          showMessage('Error loading sessions: ' + data.error, 'error');
          return;
        }
        populateSessionDropdown(data.sessions || []);
      } catch (err) {
        showMessage('Session load error: ' + err.message, 'error');
      }
    }

    function populateSessionDropdown(sessions) {
      const dropdown = document.getElementById('session-dropdown');
      dropdown.innerHTML = '<option value="">--Select a Session--</option>';
      sessions.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.spreadsheetId; 
        opt.textContent = `${s.location} - ${s.season} (${s.date})`;
        dropdown.appendChild(opt);
      });
    }

    /************************************************************
     * 8) LOAD PRODUCTS (CHAIN FILTERING)
     ************************************************************/
    document.getElementById('session-dropdown').addEventListener('change', async () => {
      const sessionId = document.getElementById('session-dropdown').value.trim();

      // Always hide the filters container until new data is loaded
      showFiltersContainer(false);
      resetProductFilters();
      allProducts = [];

      if (!sessionId) {
        // If user cleared selection, no spinner needed, just hide everything
        return;
      }

      // Show the spinner overlay
      showSessionSpinner(true);
      try {
        await loadProductsForSession(sessionId);

        // Once loaded successfully, hide spinner and show the filters
        showSessionSpinner(false);
        showFiltersContainer(true);

      } catch (err) {
        showMessage('Error loading products: ' + err.message, 'error');
        showSessionSpinner(false);
      }
    });

    async function loadProductsForSession(sessionId) {
      showMessage(`Loading products for sessionId: ${sessionId}`, 'debug');
      try {
        const url = `${GAS_PROXY}?action=getProgramList&sessionId=${encodeURIComponent(sessionId)}`;
        const resp = await fetch(url);
        const data = await resp.json();
        showMessage(`getProgramList response: ${JSON.stringify(data)}`, 'debug');

        if (!data.success) {
          showMessage('Error loading products: ' + (data.error || ''), 'error');
          return;
        }
        allProducts = data.products || [];

        populateCategoryFilter(allProducts);
        // Clear the product table initially
        renderProductTable([]);
      } catch (err) {
        showMessage('loadProductsForSession error: ' + err.message, 'error');
      }
    }

    function resetProductFilters() {
      document.getElementById('category-filter').innerHTML = '<option value="">--All Categories--</option>';
      document.getElementById('level-filter').innerHTML = '<option value="">--All Levels--</option>';
      document.getElementById('daytime-filter').innerHTML = '<option value="">--All Day/Times--</option>';
      renderProductTable([]); // Clear the table
    }

    function populateCategoryFilter(products) {
      const catSelect = document.getElementById('category-filter');
      const categories = [...new Set(products.map(p => p.category).filter(Boolean))];

      catSelect.innerHTML = '<option value="">--All Categories--</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        catSelect.appendChild(opt);
      });
    }

    document.getElementById('category-filter').addEventListener('change', () => {
      const cat = document.getElementById('category-filter').value.trim();
      let filtered = cat ? allProducts.filter(p => p.category === cat) : allProducts;

      // Populate Level dropdown
      const levels = [...new Set(filtered.map(p => p.level).filter(Boolean))];
      const levelSelect = document.getElementById('level-filter');
      levelSelect.innerHTML = '<option value="">--All Levels--</option>';
      levels.forEach(lv => {
        const opt = document.createElement('option');
        opt.value = lv;
        opt.textContent = lv;
        levelSelect.appendChild(opt);
      });

      // Reset day/time filter
      document.getElementById('daytime-filter').innerHTML = '<option value="">--All Day/Times--</option>';
      renderProductTable([]);
    });

    document.getElementById('level-filter').addEventListener('change', () => {
      const cat = document.getElementById('category-filter').value.trim();
      const lvl = document.getElementById('level-filter').value.trim();

      let filtered = allProducts;
      if (cat) filtered = filtered.filter(p => p.category === cat);
      if (lvl) filtered = filtered.filter(p => p.level === lvl);

      const dayTimes = [...new Set(filtered.map(p => p.dayTime).filter(Boolean))];
      const dtSelect = document.getElementById('daytime-filter');
      dtSelect.innerHTML = '<option value="">--All Day/Times--</option>';
      dayTimes.forEach(dt => {
        const opt = document.createElement('option');
        opt.value = dt;
        opt.textContent = dt;
        dtSelect.appendChild(opt);
      });
      renderProductTable([]);
    });

    document.getElementById('daytime-filter').addEventListener('change', () => {
      const cat = document.getElementById('category-filter').value.trim();
      const lvl = document.getElementById('level-filter').value.trim();
      const dt  = document.getElementById('daytime-filter').value.trim();

      let filtered = allProducts;
      if (cat) filtered = filtered.filter(p => p.category === cat);
      if (lvl) filtered = filtered.filter(p => p.level === lvl);
      if (dt)  filtered = filtered.filter(p => p.dayTime === dt);

      renderProductTable(filtered);
    });

    function renderProductTable(products) {
      const tbody = document.querySelector('#product-table tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      products.forEach(prod => {
        const tr = document.createElement('tr');

        let tdProgram = document.createElement('td');
        if (prod.soldOut) {
          tdProgram.innerHTML = `<s>${prod.program}</s> (Sold Out)`;
        } else {
          tdProgram.textContent = prod.program;
        }
        tr.appendChild(tdProgram);

        let tdPrice = document.createElement('td');
        tdPrice.textContent = `$${prod.price}`;
        tr.appendChild(tdPrice);

        let tdAction = document.createElement('td');
        let btnAdd = document.createElement('button');
        btnAdd.className = 'btn btn-sm btn-secondary';
        btnAdd.textContent = 'Add';
        if (prod.soldOut) {
          btnAdd.disabled = true;
        } else {
          btnAdd.onclick = () => addProductToCart(prod);
        }
        tdAction.appendChild(btnAdd);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    /************************************************************
     * 9) CART LOGIC + Payment Before Registration
     ************************************************************/
    function addProductToCart(product) {
      const sessionDropdown = document.getElementById('session-dropdown');
      const sessionLabel = sessionDropdown.options[sessionDropdown.selectedIndex].text;
      const sessionId = sessionDropdown.value; 

      cartItems.push({
        sessionId: sessionId,
        program: product.program,
        price: product.price,
        sessionLabel: sessionLabel
      });
      updateCartTable();
    }

    function updateCartTable() {
      const tbody = document.querySelector('#cart-table tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      cartItems.forEach((item, idx) => {
        const tr = document.createElement('tr');

        let tdProg = document.createElement('td');
        tdProg.textContent = item.program;
        tr.appendChild(tdProg);

        let tdSession = document.createElement('td');
        tdSession.textContent = item.sessionLabel;
        tr.appendChild(tdSession);

        let tdRemove = document.createElement('td');
        let btnRemove = document.createElement('button');
        btnRemove.className = 'btn btn-sm btn-danger';
        btnRemove.textContent = 'Remove';
        btnRemove.onclick = () => {
          cartItems.splice(idx, 1);
          updateCartTable();
        };
        tdRemove.appendChild(btnRemove);
        tr.appendChild(tdRemove);

        tbody.appendChild(tr);
      });
    }

    function calculateCartTotalCents() {
      let total = 0;
      cartItems.forEach(item => {
        total += (item.price || 0);
      });
      return total * 100; // convert to cents
    }

    async function chargeCart(email, amountInCents) {
      showMessage(`Charging cart: Email=${email}, Amount=${amountInCents} cents`, 'debug');
      try {
        const payload = { email, amount: amountInCents };
        const resp = await fetch(CHARGE_CART_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data.success) {
          showMessage('Payment succeeded in chargeCart.', 'info');
          return true;
        } else {
          showMessage('Payment failed: ' + (data.error || 'Unknown'), 'error');
          return false;
        }
      } catch (err) {
        showMessage('Network error charging cart: ' + err.message, 'error');
        return false;
      }
    }

    document.getElementById('submit-cart-button').addEventListener('click', async () => {
      if (cartItems.length === 0) {
        showMessage('Cart is empty.', 'error');
        return;
      }
      showPaymentSuccess(false);
      showPaymentSpinner(true);

      const totalCents = calculateCartTotalCents();
      showMessage(`Cart total: ${totalCents} cents`, 'debug');

      const email = currentPlayer.email;
      const success = await chargeCart(email, totalCents);
      if (!success) {
        showMessage('Payment failed, not registering.', 'error');
        showPaymentSpinner(false);
        return;
      }

      // Payment success => register in spreadsheet
      showMessage('Payment succeeded, now registering items...', 'info');
      await submitCartToSpreadsheet();
      showMessage('Successfully registered after payment!', 'success');

      // Clear cart
      cartItems = [];
      updateCartTable();

      showPaymentSpinner(false);
      showPaymentSuccess(true);
    });

    async function submitCartToSpreadsheet() {
      const payload = {
        action: 'registerMultiple',
        firstName: currentPlayer.firstName,
        lastName: currentPlayer.lastName,
        email: currentPlayer.email,
        phoneNumber: currentPlayer.phoneNumber,
        cartItems: cartItems.map(ci => ({
          sessionId: ci.sessionId,
          program: ci.program
        }))
      };

      try {
        const resp = await fetch(GAS_PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        showMessage(`registerMultiple response: ${JSON.stringify(data)}`, 'debug');
        if (!data.success) {
          showMessage('Error registering: ' + (data.error || ''), 'error');
        }
      } catch (err) {
        showMessage('submitCartToSpreadsheet error: ' + err.message, 'error');
      }
    }

    /************************************************************
     * 10) MY REGISTRATIONS
     ************************************************************/
    // Whenever the "My Registrations" tab is shown, load registrations:
    document.querySelector('a[data-bs-target="#tab-registrations"]')
      .addEventListener('shown.bs.tab', loadUserRegistrations);

    async function loadUserRegistrations() {
      if (!currentPlayer || !currentPlayer.email) {
        showMessage('No user data found for registrations.', 'error');
        return;
      }
      showMessage('Loading user registrations from getUserRegistrations', 'debug');

      // Show the registrations spinner
      showRegistrationsSpinner(true);

      const url = `${GAS_PROXY}?action=getUserRegistrations&email=${encodeURIComponent(currentPlayer.email)}`;
      try {
        const resp = await fetch(url);
        const data = await resp.json();
        showMessage(`getUserRegistrations response: ${JSON.stringify(data)}`, 'debug');

        if (!data.success) {
          showMessage('Error loading registrations: ' + (data.error || ''), 'error');
          return;
        }
        renderUpcomingRegistrations(data.upcoming || []);
      } catch (err) {
        showMessage('Load registrations error: ' + err.message, 'error');
      } finally {
        // Hide the spinner after fetching
        showRegistrationsSpinner(false);
      }
    }

    function renderUpcomingRegistrations(sessionsArray) {
      const container = document.getElementById('accordion-upcoming');
      container.innerHTML = '';
      sessionsArray.forEach((sessionObj, i) => {
        const { location, season, programs } = sessionObj;
        const itemId = `accordion-upcoming-item-${i}`;
        const itemHtml = `
          <div class="accordion-item">
            <h2 class="accordion-header" id="${itemId}-heading">
              <button class="accordion-button collapsed" type="button"
                data-bs-toggle="collapse" data-bs-target="#${itemId}-collapse"
                aria-expanded="false" aria-controls="${itemId}-collapse">
                ${location} - ${season}
              </button>
            </h2>
            <div id="${itemId}-collapse" class="accordion-collapse collapse"
              aria-labelledby="${itemId}-heading" data-bs-parent="#accordion-upcoming">
              <div class="accordion-body">
                <ul class="mb-0">
                  ${programs.map(p => `<li>${p}</li>`).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', itemHtml);
      });

      if (sessionsArray.length === 0) {
        container.innerHTML = '<p class="text-muted">No upcoming registrations found.</p>';
      }
    }

    /************************************************************
     * 11) PROFILE & LOGOUT
     ************************************************************/
    function setProfileData(player) {
      showMessage(`Setting profile data: ${JSON.stringify(player)}`, 'debug');
      document.getElementById('profile-first-name').textContent = player.firstName || '';
      document.getElementById('profile-last-name').textContent = player.lastName || '';
      document.getElementById('profile-phone').textContent = player.phoneNumber || '';
      document.getElementById('profile-email').textContent = player.email || '';

      const cardSpan = document.getElementById('profile-card-last4');
      if (cardSpan) {
        if (player.cardLast4) {
          cardSpan.textContent = `**** **** **** ${player.cardLast4}`;
        } else {
          cardSpan.textContent = 'No card on file';
        }
      }
    }

    document.getElementById('logout-button').addEventListener('click', () => {
      showMessage('Logout clicked, clearing localStorage.', 'debug');
      localStorage.removeItem('playerEmail');
      currentPlayer = null;
      cartItems = [];
      allProducts = [];
      document.getElementById('tab-content-section').style.display = 'none';
      document.getElementById('verification-section').style.display = 'block';
      showMessage('Logged out.', 'info');
    });

    /************************************************************
     * 12) UTILITY: showMessage
     ************************************************************/
    function showMessage(msg, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${msg}`);
      // Optionally display a toast or alert in the UI
    }
  </script>
</body>
</html>
